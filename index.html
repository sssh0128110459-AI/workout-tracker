<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¥èº«ç´€éŒ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* =========================
       THEME VARIABLES
    ========================== */
    :root {
      --bg: #f7f4ec;
      --card: #ffffff;
      --text: #2b2b2b;
      --subtext: #5f5f5f;
      --accent: #c5a56a;
      --accent-soft: #efe3c7;
      --border: #e0dcd2;
      --input-bg: #f3eee3;
    }

    /* æ·±è‰²ä¸»é¡Œ */
    body.dark {
      --bg: #111111;
      --card: #1f1f1f;
      --text: #f5f5f5;
      --subtext: #b3b3b3;
      --accent: #d4a15a;
      --accent-soft: #2b2216;
      --border: #3a3a3a;
      --input-bg: #161616;
    }

    /* å†°å³¶è‹”åŸï¼šé»‘ç¶ ç‚ºä¸» */
    body.iceland {
      --bg: #050806;         /* æ¥è¿‘é»‘çš„è‹”åŸå¤œè‰² */
      --card: #101a12;       /* æ·±å¢¨ç¶ å¡ç‰‡ */
      --text: #e5f3e9;       /* å¸¶ç¶ çš„æš–ç™½å­— */
      --subtext: #9bb8a6;    /* æ·¡ç¶ ç°å‰¯æ–‡å­— */
      --accent: #2faa6a;     /* å†°å†·é®®ç¶ åšé»ç¶´ */
      --accent-soft: #12251a;
      --border: #35533f;
      --input-bg: #0d1510;
    }

    /* =========================
       BASE
    ========================== */
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
        sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      transition: background 0.2s ease, color 0.2s ease;
    }

    header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      margin: 0;
      font-size: 20px;
    }

    .theme-select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 13px;
    }

    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 0 16px 24px;
    }

    .card {
      background: var(--card);
      padding: 14px 16px;
      margin-bottom: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .section-title {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .section-sub {
      font-size: 12px;
      color: var(--subtext);
    }

    /* æ—¥æœŸåˆ— */
    .date-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .date-text {
      font-size: 15px;
      font-weight: 600;
    }

    .date-nav {
      display: flex;
      gap: 6px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: var(--card);
      color: var(--text);
    }

    .btn:hover {
      background: var(--accent-soft);
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      border-color: transparent;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    /* è¨“ç·´é …ç›®ç¾¤çµ„ */
    .group {
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: linear-gradient(
        to bottom,
        rgba(0, 0, 0, 0.02),
        transparent
      );
    }

    .group-header {
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .group-name {
      font-size: 15px;
      font-weight: 600;
    }

    .group-toggle {
      font-size: 18px;
      opacity: 0.7;
    }

    .sub-list {
      display: none;
      padding: 6px 10px 8px;
      border-top: 1px solid var(--border);
    }

    .group.open .sub-list {
      display: block;
    }

    .group.open .group-toggle {
      transform: rotate(90deg);
    }

    .sub-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed var(--border);
      cursor: grab;
    }

    .sub-row:last-child {
      border-bottom: none;
    }

    .sub-main {
      flex: 1.2;
      min-width: 110px;
    }

    .sub-title {
      font-size: 13px;
      font-weight: 500;
    }

    .sub-muscle {
      font-size: 11px;
      color: var(--subtext);
    }

    .sub-inputs {
      flex: 1.4;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 4px;
    }

    .sub-inputs input {
      width: 100%;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 11px;
      text-align: center;
    }

    .sub-inputs input::placeholder {
      font-size: 11px;
      color: var(--subtext);
    }

    .sub-handle {
      font-size: 14px;
      opacity: 0.6;
      padding: 0 4px;
      user-select: none;
    }

    .add-ex-btn {
      margin-top: 6px;
      font-size: 11px;
      padding: 4px 10px;
    }

    .dragging {
      opacity: 0.6;
      border-style: dashed;
    }

    /* æ­·å²æŸ¥è©¢ */
    .history-select-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
    }

    select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 13px;
    }

    .history-list {
      font-size: 12px;
      max-height: 220px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      background: rgba(0, 0, 0, 0.02);
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px dashed var(--border);
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-date {
      font-weight: 500;
    }

    .history-meta {
      text-align: right;
      color: var(--subtext);
    }

    .status-text {
      font-size: 12px;
      color: var(--subtext);
      margin-top: 6px;
    }

    .status-ok {
      color: #3fbf6b;
    }

    .status-warn {
      color: #f0a14a;
    }

    @media (max-width: 600px) {
      .sub-inputs {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .group-header {
        padding-inline: 8px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>å¥èº«ç´€éŒ„</h1>
    <select id="themeSelector" class="theme-select">
      <option value="light">ğŸŒ æ·ºè‰²</option>
      <option value="dark">ğŸŒ™ æ·±è‰²</option>
      <option value="iceland">ğŸƒ å†°å³¶è‹”åŸ</option>
    </select>
  </header>

  <main>
    <!-- æ—¥æœŸï¼šè‡ªå‹•ä»Šå¤© + å‰ä¸€å¤© / å¾Œä¸€å¤© -->
    <section class="card">
      <div class="section-title">
        <span>ğŸ“… è¨“ç·´æ—¥æœŸ</span>
      </div>
      <div class="date-row">
        <div class="date-text" id="dateText"></div>
        <div class="date-nav">
          <button class="btn" id="prevDayBtn">â† å‰ä¸€å¤©</button>
          <button class="btn" id="nextDayBtn">å¾Œä¸€å¤© â†’</button>
        </div>
      </div>
      <div class="section-sub">æ—¥æœŸæœƒè‡ªå‹•æŠ“ä»Šå¤©ï¼Œä½ åªè¦åˆ‡æ›æŸ¥çœ‹å‰å¾Œçš„è¨“ç·´å³å¯ã€‚</div>
    </section>

    <!-- è¨“ç·´é …ç›® -->
    <section class="card">
      <div class="section-title">
        <span>ğŸ’ª è¨“ç·´é …ç›®</span>
        <span class="section-sub">å±•é–‹å¾Œå¯ç›´æ¥å¡«é‡é‡ / æ¬¡æ•¸ / çµ„æ•¸ï¼›æ‹–æ›³å¯èª¿æ•´é †åºã€‚</span>
      </div>

      <div id="groupsContainer">
        <!-- èƒ¸ -->
        <div class="group" data-group="èƒ¸">
          <div class="group-header">
            <div class="group-name">èƒ¸éƒ¨</div>
            <div class="group-toggle">â–¶</div>
          </div>
          <div class="sub-list">
            <div class="sub-row" draggable="true" data-name="å¹³æ¿å•éˆ´è‡¥æ¨">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">å¹³æ¿å•éˆ´è‡¥æ¨</div>
                <div class="sub-muscle">èƒ¸å¤§è‚Œ / è‚±ä¸‰é ­è‚Œ</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡ kg">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="ä¸Šæ–œå•éˆ´è‡¥æ¨">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">ä¸Šæ–œå•éˆ´è‡¥æ¨</div>
                <div class="sub-muscle">ä¸Šèƒ¸ / è‚±ä¸‰é ­è‚Œ</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡ kg">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="å•éˆ´é£›é³¥">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">å•éˆ´é£›é³¥</div>
                <div class="sub-muscle">èƒ¸å¤§è‚Œä¼¸å±•</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡ kg">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
            </div>

            <button class="btn add-ex-btn" data-group="èƒ¸">ï¼‹ æ–°å¢èƒ¸éƒ¨å‹•ä½œ</button>
          </div>
        </div>

        <!-- èƒŒ -->
        <div class="group" data-group="èƒŒ">
          <div class="group-header">
            <div class="group-name">èƒŒéƒ¨</div>
            <div class="group-toggle">â–¶</div>
          </div>
          <div class="sub-list">
            <div class="sub-row" draggable="true" data-name="å¼•é«”å‘ä¸Š">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">å¼•é«”å‘ä¸Š</div>
                <div class="sub-muscle">èƒŒé—Šè‚Œ / è‚±äºŒé ­è‚Œ</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="è² é‡ kg">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="é«˜ä½ä¸‹æ‹‰">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">é«˜ä½ä¸‹æ‹‰</div>
                <div class="sub-muscle">èƒŒé—Šè‚Œ</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡ kg">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="åå§¿åˆ’èˆ¹">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">åå§¿åˆ’èˆ¹</div>
                <div class="sub-muscle">è±å½¢è‚Œ / æ–œæ–¹è‚Œ / äºŒé ­</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡ kg">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
            </div>

            <button class="btn add-ex-btn" data-group="èƒŒ">ï¼‹ æ–°å¢èƒŒéƒ¨å‹•ä½œ</button>
          </div>
        </div>

        <!-- è…¿ -->
        <div class="group" data-group="è…¿">
          <div class="group-header">
            <div class="group-name">è…¿éƒ¨</div>
            <div class="group-toggle">â–¶</div>
          </div>
          <div class="sub-list">
            <div class="sub-row" draggable="true" data-name="æ·±è¹²">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">æ·±è¹²</div>
                <div class="sub-muscle">è‚¡å››é ­ / è‡€</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡ kg">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="è…¿æ¨æ©Ÿ">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">è…¿æ¨æ©Ÿ</div>
                <div class="sub-muscle">è‚¡å››é ­ / è‡€</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡ kg">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="ç¾…é¦¬å°¼äºç¡¬èˆ‰">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">ç¾…é¦¬å°¼äºç¡¬èˆ‰</div>
                <div class="sub-muscle">è…¿å¾Œè‚Œ / è‡€</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡ kg">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
            </div>

            <button class="btn add-ex-btn" data-group="è…¿">ï¼‹ æ–°å¢è…¿éƒ¨å‹•ä½œ</button>
          </div>
        </div>

        <!-- è‚© -->
        <div class="group" data-group="è‚©">
          <div class="group-header">
            <div class="group-name">è‚©éƒ¨</div>
            <div class="group-toggle">â–¶</div>
          </div>
          <div class="sub-list">
            <div class="sub-row" draggable="true" data-name="å•éˆ´è‚©æ¨">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">å•éˆ´è‚©æ¨</div>
                <div class="sub-muscle">ä¸‰è§’è‚Œå‰ä¸­æŸ</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡ kg">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="å´å¹³èˆ‰">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">å´å¹³èˆ‰</div>
                <div class="sub-muscle">ä¸‰è§’è‚Œä¸­æŸ</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡ kg">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
            </div>

            <button class="btn add-ex-btn" data-group="è‚©">ï¼‹ æ–°å¢è‚©éƒ¨å‹•ä½œ</button>
          </div>
        </div>

        <!-- æœ‰æ°§ -->
        <div class="group" data-group="æœ‰æ°§">
          <div class="group-header">
            <div class="group-name">æœ‰æ°§</div>
            <div class="group-toggle">â–¶</div>
          </div>
          <div class="sub-list">
            <div class="sub-row" draggable="true" data-name="è·‘æ­¥æ©Ÿ">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">è·‘æ­¥æ©Ÿ</div>
                <div class="sub-muscle">å¿ƒè‚º / ä¸‹è‚¢</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é€Ÿåº¦ / æ–œåº¦">
                <input class="reps-input" type="number" placeholder="æ™‚é–“ åˆ†">
                <input class="sets-input" type="number" placeholder="çµ„ / é–“æ­‡">
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="é£›è¼ªè»Š">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">é£›è¼ªè»Š</div>
                <div class="sub-muscle">è…¿éƒ¨ / å¿ƒè‚º</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é˜»åŠ›ç­‰ç´š">
                <input class="reps-input" type="number" placeholder="æ™‚é–“ åˆ†">
                <input class="sets-input" type="number" placeholder="çµ„ / é–“æ­‡">
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="è·³ç¹©">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">è·³ç¹©</div>
                <div class="sub-muscle">å°è…¿ / å¿ƒè‚º</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="ç¯€å¥ / è² é‡">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸ / ç§’">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
            </div>

            <button class="btn add-ex-btn" data-group="æœ‰æ°§">ï¼‹ æ–°å¢æœ‰æ°§å‹•ä½œ</button>
          </div>
        </div>
      </div>

      <button class="btn-primary" id="saveBtn" style="width:100%;margin-top:10px;">
        ğŸ’¾ å„²å­˜ä»Šå¤©çš„è¨“ç·´
      </button>
      <div id="saveStatus" class="status-text"></div>
    </section>

    <!-- æ­·å²æŸ¥è©¢ -->
    <section class="card">
      <div class="section-title">
        <span>ğŸ“Š æ­·å²æŸ¥è©¢</span>
      </div>
      <div class="history-select-row">
        <span class="section-sub">é¸ä¸€å€‹å‹•ä½œï¼ŒæŸ¥çœ‹ä¸åŒæ—¥æœŸçš„é‡é‡ / æ¬¡æ•¸ / çµ„æ•¸ï¼š</span>
        <select id="historyExerciseSelect">
          <option value="">è«‹é¸æ“‡å‹•ä½œ</option>
        </select>
      </div>
      <div id="historyList" class="history-list">
        <div class="section-sub">ç›®å‰å°šæœªé¸æ“‡å‹•ä½œæˆ–å°šç„¡ç´€éŒ„ã€‚</div>
      </div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = "trainingV3";

    // ===== æ—¥æœŸè™•ç† =====
    let currentDate = new Date();

    function formatDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatDisplay(d) {
      const y = d.getFullYear();
      const m = d.getMonth() + 1;
      const day = d.getDate();
      return `${y} / ${m} / ${day}`;
    }

    function updateDateDisplay() {
      document.getElementById("dateText").textContent = formatDisplay(currentDate);
      loadDataForDate(formatDate(currentDate));
    }

    // ===== å„²å­˜ / è®€å– =====
    function loadAll() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error("è®€å–å¤±æ•—", e);
        return [];
      }
    }

    function saveAll(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadDataForDate(dateStr) {
      const all = loadAll();
      const found = all.find((d) => d.date === dateStr);

      // æ¸…ç©ºæ‰€æœ‰è¼¸å…¥
      document.querySelectorAll(".sub-row").forEach((row) => {
        row.querySelector(".weight-input").value = "";
        row.querySelector(".reps-input").value = "";
        row.querySelector(".sets-input").value = "";
      });

      if (found && Array.isArray(found.records)) {
        found.records.forEach((r) => {
          const selector = `.group[data-group="${r.group}"] .sub-row[data-name="${r.name}"]`;
          const row = document.querySelector(selector);
          if (row) {
            row.querySelector(".weight-input").value = r.weight ?? "";
            row.querySelector(".reps-input").value = r.reps ?? "";
            row.querySelector(".sets-input").value = r.sets ?? "";
          }
        });
        setStatus("å·²è¼‰å…¥ " + dateStr + " çš„ç´€éŒ„", "ok");
      } else {
        setStatus("æ­¤æ—¥æœŸå°šç„¡ç´€éŒ„ï¼Œå¯ä»¥é–‹å§‹è¨˜éŒ„ã€‚", "warn");
      }
    }

    function setStatus(text, type) {
      const el = document.getElementById("saveStatus");
      el.textContent = text;
      el.classList.remove("status-ok", "status-warn");
      if (type === "ok") el.classList.add("status-ok");
      if (type === "warn") el.classList.add("status-warn");
    }

    function collectRecordsFromUI() {
      const records = [];
      document.querySelectorAll(".group").forEach((group) => {
        const groupName = group.getAttribute("data-group");
        group.querySelectorAll(".sub-row").forEach((row) => {
          const name = row.getAttribute("data-name");
          const weight = row.querySelector(".weight-input").value;
          const reps = row.querySelector(".reps-input").value;
          const sets = row.querySelector(".sets-input").value;

          if (weight || reps || sets) {
            records.push({
              group: groupName,
              name,
              weight: weight ? Number(weight) : null,
              reps: reps ? Number(reps) : null,
              sets: sets ? Number(sets) : null,
            });
          }
        });
      });
      return records;
    }

    // ===== æ­·å²æŸ¥è©¢ =====
    function rebuildHistoryExerciseOptions() {
      const all = loadAll();
      const set = new Set();

      // æŠŠç›®å‰ UI çš„å‹•ä½œåä¹ŸåŠ é€²ä¾†ï¼ˆå³ä½¿é‚„æ²’ç´€éŒ„éï¼‰
      document.querySelectorAll(".sub-row").forEach((row) => {
        const name = row.getAttribute("data-name");
        if (name) set.add(name);
      });

      all.forEach((day) => {
        if (!Array.isArray(day.records)) return;
        day.records.forEach((r) => {
          if (r.name) set.add(r.name);
        });
      });

      const select = document.getElementById("historyExerciseSelect");
      const current = select.value;
      select.innerHTML = `<option value="">è«‹é¸æ“‡å‹•ä½œ</option>`;
      Array.from(set)
        .sort()
        .forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });

      if (current && set.has(current)) {
        select.value = current;
        showHistoryForExercise(current);
      } else {
        document.getElementById("historyList").innerHTML =
          `<div class="section-sub">ç›®å‰å°šæœªé¸æ“‡å‹•ä½œæˆ–å°šç„¡ç´€éŒ„ã€‚</div>`;
      }
    }

    function showHistoryForExercise(name) {
      const all = loadAll().slice().sort((a, b) =>
        a.date < b.date ? -1 : a.date > b.date ? 1 : 0
      );
      const container = document.getElementById("historyList");
      container.innerHTML = "";

      const filtered = [];
      all.forEach((day) => {
        const match = day.records?.find((r) => r.name === name);
        if (match) {
          filtered.push({ date: day.date, ...match });
        }
      });

      if (filtered.length === 0) {
        container.innerHTML =
          `<div class="section-sub">é€™å€‹å‹•ä½œç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</div>`;
        return;
      }

      filtered.forEach((item) => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `
          <div class="history-date">${item.date}</div>
          <div class="history-meta">
            <div>${item.weight ?? "-"} kg Ã— ${item.reps ?? "-"} ä¸‹</div>
            <div>${item.sets ?? "-"} çµ„</div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // ===== ä¸»é¡Œåˆ‡æ› =====
    function applyTheme(theme) {
      document.body.classList.remove("dark", "iceland");
      if (theme === "dark") document.body.classList.add("dark");
      if (theme === "iceland") document.body.classList.add("iceland");
      localStorage.setItem("workoutTheme", theme);
    }

    // ===== æ‹–æ›³æ’åº =====
    function enableDrag(container) {
      let draggingEl = null;

      container.addEventListener("dragstart", (e) => {
        const row = e.target.closest(".sub-row");
        if (!row) return;
        draggingEl = row;
        row.classList.add("dragging");
      });

      container.addEventListener("dragend", (e) => {
        const row = e.target.closest(".sub-row");
        if (row) row.classList.remove("dragging");
        draggingEl = null;
      });

      container.addEventListener("dragover", (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);
        if (!draggingEl) return;
        if (afterElement == null) {
          container.insertBefore(draggingEl, container.lastElementChild); // before add-button
        } else {
          container.insertBefore(draggingEl, afterElement);
        }
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [
        ...container.querySelectorAll(".sub-row:not(.dragging)"),
      ];
      let closest = { offset: Number.NEGATIVE_INFINITY, element: null };

      draggableElements.forEach((child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          closest = { offset, element: child };
        }
      });
      return closest.element;
    }

    // ===== æ–°å¢å‹•ä½œ =====
    function addExerciseRow(groupEl, groupName, name, muscle) {
      const list = groupEl.querySelector(".sub-list");
      const addBtn = list.querySelector(".add-ex-btn");

      const row = document.createElement("div");
      row.className = "sub-row";
      row.setAttribute("draggable", "true");
      row.setAttribute("data-name", name);

      row.innerHTML = `
        <div class="sub-handle">â˜°</div>
        <div class="sub-main">
          <div class="sub-title">${name}</div>
          <div class="sub-muscle">${muscle || ""}</div>
        </div>
        <div class="sub-inputs">
          <input class="weight-input" type="number" placeholder="é‡é‡ kg">
          <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
          <input class="sets-input" type="number" placeholder="çµ„æ•¸">
        </div>
      `;

      list.insertBefore(row, addBtn);
    }

    // ===== åˆå§‹åŒ– =====
    document.addEventListener("DOMContentLoaded", () => {
      // ä¸»é¡Œ
      const themeSelector = document.getElementById("themeSelector");
      const savedTheme = localStorage.getItem("workoutTheme") || "light";
      themeSelector.value = savedTheme;
      applyTheme(savedTheme);

      themeSelector.addEventListener("change", () => {
        applyTheme(themeSelector.value);
      });

      // æ—¥æœŸ
      document
        .getElementById("prevDayBtn")
        .addEventListener("click", () => {
          currentDate.setDate(currentDate.getDate() - 1);
          updateDateDisplay();
        });

      document
        .getElementById("nextDayBtn")
        .addEventListener("click", () => {
          currentDate.setDate(currentDate.getDate() + 1);
          updateDateDisplay();
        });

      updateDateDisplay();

      // å±•é–‹ / æ”¶åˆç¾¤çµ„
      document.querySelectorAll(".group-header").forEach((header) => {
        header.addEventListener("click", () => {
          const group = header.closest(".group");
          group.classList.toggle("open");
        });
      });

      // æ‹–æ›³å•Ÿç”¨
      document.querySelectorAll(".group .sub-list").forEach((list) => {
        enableDrag(list);
      });

      // æ–°å¢å‹•ä½œæŒ‰éˆ•
      document.querySelectorAll(".add-ex-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const groupName = btn.getAttribute("data-group");
          const groupEl = btn.closest(".group");
          const name = prompt(`æ–°å¢ã€Œ${groupName}ã€å‹•ä½œåç¨±ï¼š`);
          if (!name) return;
          const muscle = prompt("é€™å€‹å‹•ä½œä¸»è¦è¨“ç·´çš„è‚Œç¾¤ï¼ˆå¯ç•™ç™½ï¼‰ï¼š") || "";
          addExerciseRow(groupEl, groupName, name, muscle);
        });
      });

      // å„²å­˜
      document.getElementById("saveBtn").addEventListener("click", () => {
        const dateStr = formatDate(currentDate);
        const records = collectRecordsFromUI();
        const all = loadAll();
        const idx = all.findIndex((d) => d.date === dateStr);

        if (records.length === 0) {
          if (idx >= 0) {
            all.splice(idx, 1);
            saveAll(all);
            setStatus("å·²åˆªé™¤æ­¤æ—¥æœŸçš„æ‰€æœ‰ç´€éŒ„ï¼ˆå› ç‚ºä½ æ¸…ç©ºäº†æ‰€æœ‰æ¬„ä½ï¼‰ã€‚", "warn");
          } else {
            setStatus("æ²’æœ‰å¯å„²å­˜çš„å…§å®¹ã€‚", "warn");
          }
        } else {
          const newObj = { date: dateStr, records };
          if (idx >= 0) all[idx] = newObj;
          else all.push(newObj);
          saveAll(all);
          setStatus("å·²å„²å­˜ " + dateStr + " çš„è¨“ç·´ç´€éŒ„ã€‚", "ok");
        }

        rebuildHistoryExerciseOptions();
      });

      // æ­·å²æŸ¥è©¢
      document
        .getElementById("historyExerciseSelect")
        .addEventListener("change", (e) => {
          const name = e.target.value;
          if (!name) {
            document.getElementById("historyList").innerHTML =
              `<div class="section-sub">ç›®å‰å°šæœªé¸æ“‡å‹•ä½œæˆ–å°šç„¡ç´€éŒ„ã€‚</div>`;
            return;
          }
          showHistoryForExercise(name);
        });

      rebuildHistoryExerciseOptions();
    });
  </script>
</body>
</html>
