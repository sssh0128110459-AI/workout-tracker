<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¥èº«ç´€éŒ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* =========================
       THEME VARIABLES
    ========================== */
    :root {
      --bg: #f7f4ec;
      --card: #ffffff;
      --text: #2b2b2b;
      --subtext: #5f5f5f;
      --accent: #c5a56a;
      --accent-soft: #efe3c7;
      --border: #e0dcd2;
      --input-bg: #f3eee3;
    }

    body.dark {
      --bg: #111111;
      --card: #1f1f1f;
      --text: #f5f5f5;
      --subtext: #b3b3b3;
      --accent: #d4a15a;
      --accent-soft: #2b2216;
      --border: #3a3a3a;
      --input-bg: #161616;
    }

    body.iceland {
      --bg: #050806;
      --card: #101a12;
      --text: #e5f3e9;
      --subtext: #9bb8a6;
      --accent: #2faa6a;
      --accent-soft: #12251a;
      --border: #35533f;
      --input-bg: #0d1510;
    }

    /* =========================
       BASE
    ========================== */
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
        sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      transition: background 0.2s ease, color 0.2s ease;
    }

    header {
      padding: 16px;
      display: flex;
      justify-content: flex-start;
      align-items: center;
    }

    h1 {
      margin: 0;
      font-size: 20px;
    }

    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 0 16px 24px;
    }

    .card {
      position: relative;
      background: var(--card);
      padding: 12px 14px;
      margin-bottom: 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
    }

    .section-title {
      font-weight: 700;
      margin-bottom: 8px;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .section-toolbar {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-sub-right {
      font-size: 11px;
      color: var(--subtext);
      text-align: right;
      line-height: 1.4;
    }

    .btn-mini {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      background: var(--card);
      color: var(--text);
    }

    .btn-mini:hover {
      background: var(--accent-soft);
    }

    .status-text {
      font-size: 11px;
      color: var(--subtext);
      margin-top: 4px;
    }

    .status-ok {
      color: #3fbf6b;
    }

    .status-warn {
      color: #f0a14a;
    }

    /* å·¥å…·é¢æ¿ï¼ˆä¸»é¡Œ + å„²å­˜ + æ­·å²ï¼‰ */
    .tools-panel {
      position: absolute;
      top: 40px;
      right: 12px;
      width: min(320px, 80vw);
      background: var(--card);
      border-radius: 10px;
      border: 1px solid var(--border);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
      padding: 8px 10px;
      font-size: 11px;
      display: none;
      z-index: 10;
    }

    .tools-panel.open {
      display: block;
    }

    .tools-section {
      margin-bottom: 6px;
      padding-bottom: 6px;
      border-bottom: 1px dashed var(--border);
    }

    .tools-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .tools-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .tools-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .theme-select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 11px;
    }

    .btn-mini-primary {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 5px 8px;
      font-size: 11px;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      width: 100%;
    }

    .btn-mini-primary:hover {
      filter: brightness(1.05);
    }

    /* è¨“ç·´é …ç›®ç¾¤çµ„ */
    .group {
      margin-bottom: 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: linear-gradient(
        to bottom,
        rgba(0, 0, 0, 0.015),
        transparent
      );
    }

    .group-header {
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .group-name {
      font-size: 14px;
      font-weight: 600;
    }

    .group-toggle {
      font-size: 18px;
      opacity: 0.7;
      transition: transform 0.15s ease;
    }

    .group.open .group-toggle {
      transform: rotate(90deg);
    }

    .sub-list {
      display: none;
      padding: 4px 10px 8px;
      border-top: 1px solid var(--border);
    }

    .group.open .sub-list {
      display: block;
    }

    /* å°æ¨™é¡Œåˆ—ï¼šé‡é‡ / æ¬¡æ•¸ / çµ„æ•¸ */
    .sub-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 4px 0 6px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      color: var(--subtext);
    }

    .sub-header-handle {
      width: 20px;
      padding: 0 4px;
    }

    .sub-header-main {
      flex: 1.5;
    }

    .sub-header-inputs {
      flex: 1.8;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      column-gap: 8px;
      text-align: center;
    }

    .sub-header-inputs span {
      display: block;
      white-space: nowrap;
    }

    .sub-header-actions {
      width: 40px;
      text-align: center;
      font-size: 11px;
      color: var(--subtext);
    }

    /* æ¯åˆ—å‹•ä½œ */
    .sub-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed var(--border);
      cursor: grab;
    }

    .sub-row:last-child {
      border-bottom: none;
    }

    .sub-main {
      flex: 1.5;
      min-width: 110px;
    }

    .sub-title {
      font-size: 13px;
      font-weight: 500;
    }

    .sub-muscle {
      font-size: 11px;
      color: var(--subtext);
    }

    .sub-inputs {
      flex: 1.8;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      column-gap: 8px;
      row-gap: 4px;
    }

    .sub-inputs input {
      width: 100%;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 11px;
      text-align: center;
    }

    .sub-inputs input::placeholder {
      font-size: 11px;
      color: var(--subtext);
    }

    .sub-handle {
      font-size: 14px;
      opacity: 0.6;
      padding: 0 4px;
      user-select: none;
    }

    .sub-actions {
      width: 40px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
      justify-content: center;
    }

    .icon-btn {
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--card);
      font-size: 11px;
      padding: 2px 4px;
      cursor: pointer;
      color: var(--subtext);
    }

    .icon-btn:hover {
      background: var(--accent-soft);
    }

    .add-ex-btn {
      margin-top: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      background: rgba(0,0,0,0.02);
      cursor: pointer;
    }

    .add-ex-btn:hover {
      background: var(--accent-soft);
    }

    .dragging {
      opacity: 0.6;
      border-style: dashed;
    }

    /* æ­·å²å€å¡Šï¼ˆåœ¨å·¥å…·é¢æ¿å…§ï¼‰ */
    .history-select-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 4px;
    }

    select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 11px;
    }

    .history-list {
      font-size: 11px;
      max-height: 140px;
      overflow-y: auto;
      border-radius: 6px;
      border: 1px solid var(--border);
      padding: 4px 6px;
      background: rgba(0, 0, 0, 0.02);
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px dashed var(--border);
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-date {
      font-weight: 500;
    }

    .history-meta {
      text-align: right;
      color: var(--subtext);
    }

    @media (max-width: 600px) {
      .section-title {
        align-items: center;
      }
      .sub-header-row {
        font-size: 10px;
      }
      .sub-actions {
        width: 34px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>å¥èº«ç´€éŒ„</h1>
  </header>

  <main>
    <section class="card">
      <div class="section-title">
        <span>ğŸ’ª è¨“ç·´é …ç›®</span>
        <div class="section-toolbar">
          <div class="section-sub-right" id="currentDateLabel"></div>
          <button class="btn-mini" id="toolsBtn">â‹¯</button>
        </div>
      </div>

      <!-- å·¥å…·é¢æ¿ï¼šä¸»é¡Œ + å„²å­˜ + æ­·å² -->
      <div id="toolsPanel" class="tools-panel">
        <div class="tools-section">
          <div class="tools-title">ä¸»é¡Œ</div>
          <div class="tools-row">
            <span>èƒŒæ™¯é¡è‰²</span>
            <select id="themeSelector" class="theme-select">
              <option value="light">æ·ºè‰²</option>
              <option value="dark">æ·±è‰²</option>
              <option value="iceland">å†°å³¶è‹”åŸ</option>
            </select>
          </div>
        </div>

        <div class="tools-section">
          <button class="btn-mini-primary" id="saveBtn">ğŸ’¾ å„²å­˜ä»Šå¤©è¨“ç·´</button>
        </div>

        <div class="tools-section">
          <div class="tools-title">æ­·å²æŸ¥è©¢</div>
          <div class="history-select-row">
            <span style="flex:1 1 auto;">é¸æ“‡å‹•ä½œï¼š</span>
            <select id="historyExerciseSelect">
              <option value="">è«‹é¸æ“‡</option>
            </select>
          </div>
          <div id="historyList" class="history-list">
            <div style="color:var(--subtext);">
              å°šæœªé¸æ“‡å‹•ä½œæˆ–å°šç„¡ç´€éŒ„ã€‚
            </div>
          </div>
        </div>
      </div>

      <div id="groupsContainer">
        <!--=== èƒ¸éƒ¨ ===-->
        <div class="group" data-group="èƒ¸">
          <div class="group-header">
            <div class="group-name">èƒ¸éƒ¨</div>
            <div class="group-toggle">â–¶</div>
          </div>
          <div class="sub-list">
            <div class="sub-header-row">
              <div class="sub-header-handle"></div>
              <div class="sub-header-main">å‹•ä½œ</div>
              <div class="sub-header-inputs">
                <span>é‡é‡ kg</span>
                <span>æ¬¡æ•¸</span>
                <span>çµ„æ•¸</span>
              </div>
              <div class="sub-header-actions"></div>
            </div>

            <div class="sub-row" draggable="true" data-name="å¹³æ¿å•éˆ´è‡¥æ¨">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">å¹³æ¿å•éˆ´è‡¥æ¨</div>
                <div class="sub-muscle">èƒ¸å¤§è‚Œ / è‚±ä¸‰é ­è‚Œ</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="ä¸Šæ–œå•éˆ´è‡¥æ¨">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">ä¸Šæ–œå•éˆ´è‡¥æ¨</div>
                <div class="sub-muscle">ä¸Šèƒ¸ / è‚±ä¸‰é ­è‚Œ</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="å•éˆ´é£›é³¥">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">å•éˆ´é£›é³¥</div>
                <div class="sub-muscle">èƒ¸å¤§è‚Œä¼¸å±•</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <button class="add-ex-btn" data-group="èƒ¸">ï¼‹ æ–°å¢èƒ¸éƒ¨å‹•ä½œ</button>
          </div>
        </div>

        <!--=== èƒŒéƒ¨ ===-->
        <div class="group" data-group="èƒŒ">
          <div class="group-header">
            <div class="group-name">èƒŒéƒ¨</div>
            <div class="group-toggle">â–¶</div>
          </div>
          <div class="sub-list">
            <div class="sub-header-row">
              <div class="sub-header-handle"></div>
              <div class="sub-header-main">å‹•ä½œ</div>
              <div class="sub-header-inputs">
                <span>é‡é‡ kg</span>
                <span>æ¬¡æ•¸</span>
                <span>çµ„æ•¸</span>
              </div>
              <div class="sub-header-actions"></div>
            </div>

            <div class="sub-row" draggable="true" data-name="å¼•é«”å‘ä¸Š">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">å¼•é«”å‘ä¸Š</div>
                <div class="sub-muscle">èƒŒé—Šè‚Œ / è‚±äºŒé ­è‚Œ</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="é«˜ä½ä¸‹æ‹‰">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">é«˜ä½ä¸‹æ‹‰</div>
                <div class="sub-muscle">èƒŒé—Šè‚Œ</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="åå§¿åˆ’èˆ¹">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">åå§¿åˆ’èˆ¹</div>
                <div class="sub-muscle">è±å½¢è‚Œ / æ–œæ–¹è‚Œ / äºŒé ­</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <button class="add-ex-btn" data-group="èƒŒ">ï¼‹ æ–°å¢èƒŒéƒ¨å‹•ä½œ</button>
          </div>
        </div>

        <!--=== è…¿éƒ¨ ===-->
        <div class="group" data-group="è…¿">
          <div class="group-header">
            <div class="group-name">è…¿éƒ¨</div>
            <div class="group-toggle">â–¶</div>
          </div>
          <div class="sub-list">
            <div class="sub-header-row">
              <div class="sub-header-handle"></div>
              <div class="sub-header-main">å‹•ä½œ</div>
              <div class="sub-header-inputs">
                <span>é‡é‡ kg</span>
                <span>æ¬¡æ•¸</span>
                <span>çµ„æ•¸</span>
              </div>
              <div class="sub-header-actions"></div>
            </div>

            <div class="sub-row" draggable="true" data-name="æ·±è¹²">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">æ·±è¹²</div>
                <div class="sub-muscle">è‚¡å››é ­ / è‡€</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="è…¿æ¨æ©Ÿ">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">è…¿æ¨æ©Ÿ</div>
                <div class="sub-muscle">è‚¡å››é ­ / è‡€</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="ç¾…é¦¬å°¼äºç¡¬èˆ‰">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">ç¾…é¦¬å°¼äºç¡¬èˆ‰</div>
                <div class="sub-muscle">è…¿å¾Œè‚Œ / è‡€</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <button class="add-ex-btn" data-group="è…¿">ï¼‹ æ–°å¢è…¿éƒ¨å‹•ä½œ</button>
          </div>
        </div>

        <!--=== è‚©éƒ¨ ===-->
        <div class="group" data-group="è‚©">
          <div class="group-header">
            <div class="group-name">è‚©éƒ¨</div>
            <div class="group-toggle">â–¶</div>
          </div>
          <div class="sub-list">
            <div class="sub-header-row">
              <div class="sub-header-handle"></div>
              <div class="sub-header-main">å‹•ä½œ</div>
              <div class="sub-header-inputs">
                <span>é‡é‡ kg</span>
                <span>æ¬¡æ•¸</span>
                <span>çµ„æ•¸</span>
              </div>
              <div class="sub-header-actions"></div>
            </div>

            <div class="sub-row" draggable="true" data-name="å•éˆ´è‚©æ¨">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">å•éˆ´è‚©æ¨</div>
                <div class="sub-muscle">ä¸‰è§’è‚Œå‰ä¸­æŸ</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="å´å¹³èˆ‰">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">å´å¹³èˆ‰</div>
                <div class="sub-muscle">ä¸‰è§’è‚Œä¸­æŸ</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="é‡é‡">
                <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <button class="add-ex-btn" data-group="è‚©">ï¼‹ æ–°å¢è‚©éƒ¨å‹•ä½œ</button>
          </div>
        </div>

        <!--=== æœ‰æ°§ ===-->
        <div class="group" data-group="æœ‰æ°§">
          <div class="group-header">
            <div class="group-name">æœ‰æ°§</div>
            <div class="group-toggle">â–¶</div>
          </div>
          <div class="sub-list">
            <div class="sub-header-row">
              <div class="sub-header-handle"></div>
              <div class="sub-header-main">å‹•ä½œ</div>
              <div class="sub-header-inputs">
                <span>å¼·åº¦</span>
                <span>æ™‚é–“</span>
                <span>çµ„ / é–“æ­‡</span>
              </div>
              <div class="sub-header-actions"></div>
            </div>

            <div class="sub-row" draggable="true" data-name="è·‘æ­¥æ©Ÿ">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">è·‘æ­¥æ©Ÿ</div>
                <div class="sub-muscle">å¿ƒè‚º / ä¸‹è‚¢</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="å¼·åº¦">
                <input class="reps-input" type="number" placeholder="æ™‚é–“">
                <input class="sets-input" type="number" placeholder="çµ„ / é–“æ­‡">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="é£›è¼ªè»Š">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">é£›è¼ªè»Š</div>
                <div class="sub-muscle">è…¿éƒ¨ / å¿ƒè‚º</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="å¼·åº¦">
                <input class="reps-input" type="number" placeholder="æ™‚é–“">
                <input class="sets-input" type="number" placeholder="çµ„ / é–“æ­‡">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <div class="sub-row" draggable="true" data-name="è·³ç¹©">
              <div class="sub-handle">â˜°</div>
              <div class="sub-main">
                <div class="sub-title">è·³ç¹©</div>
                <div class="sub-muscle">å°è…¿ / å¿ƒè‚º</div>
              </div>
              <div class="sub-inputs">
                <input class="weight-input" type="number" placeholder="å¼·åº¦">
                <input class="reps-input" type="number" placeholder="æ™‚é–“">
                <input class="sets-input" type="number" placeholder="çµ„æ•¸">
              </div>
              <div class="sub-actions">
                <button type="button" class="icon-btn edit-ex-btn">âœ</button>
              </div>
            </div>

            <button class="add-ex-btn" data-group="æœ‰æ°§">ï¼‹ æ–°å¢æœ‰æ°§å‹•ä½œ</button>
          </div>
        </div>
      </div>

      <div id="saveStatus" class="status-text"></div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = "trainingV3";

    function formatDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    /* ===== å„²å­˜ / è®€å– ===== */
    function loadAll() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveAll(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function clearAllInputs() {
      document.querySelectorAll(".sub-row").forEach((row) => {
        row.querySelector(".weight-input").value = "";
        row.querySelector(".reps-input").value = "";
        row.querySelector(".sets-input").value = "";
      });
    }

    function loadDataForDate(dateStr) {
      const all = loadAll();
      const found = all.find((d) => d.date === dateStr);

      clearAllInputs();

      if (found && Array.isArray(found.records)) {
        found.records.forEach((r) => {
          const selector = `.group[data-group="${r.group}"] .sub-row[data-name="${r.name}"]`;
          const row = document.querySelector(selector);
          if (row) {
            row.querySelector(".weight-input").value = r.weight ?? "";
            row.querySelector(".reps-input").value = r.reps ?? "";
            row.querySelector(".sets-input").value = r.sets ?? "";
          }
        });
        setStatus("å·²è¼‰å…¥ " + dateStr + " çš„è¨“ç·´ç´€éŒ„ã€‚", "ok");
      } else {
        setStatus("å°šæœªæœ‰é€™å¤©çš„ç´€éŒ„ã€‚", "warn");
      }
    }

    function setStatus(text, type) {
      const el = document.getElementById("saveStatus");
      el.textContent = text;
      el.classList.remove("status-ok", "status-warn");
      if (type === "ok") el.classList.add("status-ok");
      if (type === "warn") el.classList.add("status-warn");
    }

    function collectRecordsFromUI() {
      const records = [];
      document.querySelectorAll(".group").forEach((group) => {
        const groupName = group.getAttribute("data-group");
        group.querySelectorAll(".sub-row").forEach((row) => {
          const name = row.getAttribute("data-name");
          const weight = row.querySelector(".weight-input").value;
          const reps = row.querySelector(".reps-input").value;
          const sets = row.querySelector(".sets-input").value;

          if (weight || reps || sets) {
            records.push({
              group: groupName,
              name,
              weight: weight ? Number(weight) : null,
              reps: reps ? Number(reps) : null,
              sets: sets ? Number(sets) : null,
            });
          }
        });
      });
      return records;
    }

    /* ===== æ­·å²æŸ¥è©¢ ===== */
    function rebuildHistoryExerciseOptions() {
      const all = loadAll();
      const set = new Set();

      document.querySelectorAll(".sub-row").forEach((row) => {
        const name = row.getAttribute("data-name");
        if (name) set.add(name);
      });

      all.forEach((day) => {
        if (!Array.isArray(day.records)) return;
        day.records.forEach((r) => {
          if (r.name) set.add(r.name);
        });
      });

      const select = document.getElementById("historyExerciseSelect");
      const current = select.value;
      select.innerHTML = `<option value="">è«‹é¸æ“‡</option>`;
      Array.from(set)
        .sort()
        .forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });

      if (current && set.has(current)) {
        select.value = current;
        showHistoryForExercise(current);
      } else {
        document.getElementById("historyList").innerHTML =
          `<div style="color:var(--subtext);">å°šæœªé¸æ“‡å‹•ä½œæˆ–å°šç„¡ç´€éŒ„ã€‚</div>`;
      }
    }

    function showHistoryForExercise(name) {
      const all = loadAll().slice().sort((a, b) =>
        a.date < b.date ? -1 : a.date > b.date ? 1 : 0
      );
      const container = document.getElementById("historyList");
      container.innerHTML = "";

      const filtered = [];
      all.forEach((day) => {
        const match = day.records?.find((r) => r.name === name);
        if (match) {
          filtered.push({ date: day.date, ...match });
        }
      });

      if (filtered.length === 0) {
        container.innerHTML =
          `<div style="color:var(--subtext);">é€™å€‹å‹•ä½œç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</div>`;
        return;
      }

      filtered.forEach((item) => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `
          <div class="history-date">${item.date}</div>
          <div class="history-meta">
            <div>${item.weight ?? "-"} kg Ã— ${item.reps ?? "-"} æ¬¡</div>
            <div>${item.sets ?? "-"} çµ„</div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    /* ===== ä¸»é¡Œåˆ‡æ› ===== */
    function applyTheme(theme) {
      document.body.classList.remove("dark", "iceland");
      if (theme === "dark") document.body.classList.add("dark");
      if (theme === "iceland") document.body.classList.add("iceland");
      localStorage.setItem("workoutTheme", theme);
    }

    /* ===== æ‹–æ›³æ’åº ===== */
    function enableDrag(container) {
      let draggingEl = null;

      container.addEventListener("dragstart", (e) => {
        const handle = e.target.closest(".sub-handle");
        if (!handle) {
          e.preventDefault();
          return;
        }
        const row = handle.closest(".sub-row");
        draggingEl = row;
        row.classList.add("dragging");
      });

      container.addEventListener("dragend", (e) => {
        const row = e.target.closest(".sub-row");
        if (row) row.classList.remove("dragging");
        draggingEl = null;
      });

      container.addEventListener("dragover", (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);
        if (!draggingEl) return;
        const addBtn = container.querySelector(".add-ex-btn");

        if (!afterElement || afterElement === addBtn) {
          container.insertBefore(draggingEl, addBtn);
        } else {
          container.insertBefore(draggingEl, afterElement);
        }
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [
        ...container.querySelectorAll(".sub-row:not(.dragging)"),
      ];
      let closest = { offset: Number.NEGATIVE_INFINITY, element: null };

      draggableElements.forEach((child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          closest = { offset, element: child };
        }
      });
      return closest.element;
    }

    /* ===== æ–°å¢å‹•ä½œ ===== */
    function addExerciseRow(groupEl, groupName, name, muscle) {
      const list = groupEl.querySelector(".sub-list");
      const addBtn = list.querySelector(".add-ex-btn");

      const row = document.createElement("div");
      row.className = "sub-row";
      row.setAttribute("draggable", "true");
      row.setAttribute("data-name", name);

      const isCardio = groupName === "æœ‰æ°§";
      let inputsHTML;

      if (isCardio) {
        inputsHTML = `
          <div class="sub-inputs">
            <input class="weight-input" type="number" placeholder="å¼·åº¦">
            <input class="reps-input" type="number" placeholder="æ™‚é–“">
            <input class="sets-input" type="number" placeholder="çµ„ / é–“æ­‡">
          </div>
        `;
      } else {
        inputsHTML = `
          <div class="sub-inputs">
            <input class="weight-input" type="number" placeholder="é‡é‡">
            <input class="reps-input" type="number" placeholder="æ¬¡æ•¸">
            <input class="sets-input" type="number" placeholder="çµ„æ•¸">
          </div>
        `;
      }

      row.innerHTML = `
        <div class="sub-handle">â˜°</div>
        <div class="sub-main">
          <div class="sub-title">${name}</div>
          <div class="sub-muscle">${muscle || ""}</div>
        </div>
        ${inputsHTML}
        <div class="sub-actions">
          <button type="button" class="icon-btn edit-ex-btn">âœ</button>
        </div>
      `;

      list.insertBefore(row, addBtn);
    }

    /* ===== æœ€è¿‘ä¸€æ¬¡è¨“ç·´ ===== */
    function loadLatestSession() {
      const all = loadAll();
      const labelEl = document.getElementById("currentDateLabel");

      if (!all.length) {
        clearAllInputs();
        labelEl.textContent = "ç›®å‰é¡¯ç¤ºï¼šå°šæœªæœ‰è¨“ç·´ç´€éŒ„";
        setStatus("å°šæœªæœ‰è¨“ç·´ç´€éŒ„ï¼Œå…ˆå¡«å¯«ä¸€æ¬¡å§ã€‚", "warn");
        return;
      }

      all.sort((a, b) => (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));
      const last = all[all.length - 1];
      labelEl.textContent = "ç›®å‰é¡¯ç¤ºï¼š" + last.date + "ï¼ˆæœ€è¿‘ä¸€æ¬¡ï¼‰";
      loadDataForDate(last.date);
    }

    /* ===== åˆå§‹åŒ– ===== */
    document.addEventListener("DOMContentLoaded", () => {
      // å·¥å…·é¢æ¿é–‹é—œ
      const toolsBtn = document.getElementById("toolsBtn");
      const toolsPanel = document.getElementById("toolsPanel");
      toolsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        toolsPanel.classList.toggle("open");
        if (toolsPanel.classList.contains("open")) {
          rebuildHistoryExerciseOptions();
        }
      });

      // é»ç•«é¢ç©ºç™½è™•é—œé–‰é¢æ¿
      document.addEventListener("click", (e) => {
        if (!e.target.closest("#toolsPanel") && !e.target.closest("#toolsBtn")) {
          toolsPanel.classList.remove("open");
        }
      });

      // ä¸»é¡Œ
      const themeSelector = document.getElementById("themeSelector");
      const savedTheme = localStorage.getItem("workoutTheme") || "light";
      themeSelector.value = savedTheme;
      applyTheme(savedTheme);
      themeSelector.addEventListener("change", () => {
        applyTheme(themeSelector.value);
      });

      // å±•é–‹ / æ”¶åˆç¾¤çµ„
      document.querySelectorAll(".group-header").forEach((header) => {
        header.addEventListener("click", () => {
          const group = header.closest(".group");
          group.classList.toggle("open");
        });
      });

      // æ‹–æ›³å•Ÿç”¨
      document.querySelectorAll(".group .sub-list").forEach((list) => {
        enableDrag(list);
      });

      // æ–°å¢å‹•ä½œ
      document.querySelectorAll(".add-ex-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const groupName = btn.getAttribute("data-group");
          const groupEl = btn.closest(".group");
          const name = prompt(`æ–°å¢ã€Œ${groupName}ã€å‹•ä½œåç¨±ï¼š`);
          if (!name) return;
          const muscle = prompt("é€™å€‹å‹•ä½œä¸»è¦è¨“ç·´çš„è‚Œç¾¤ï¼ˆå¯ç•™ç™½ï¼‰ï¼š") || "";
          addExerciseRow(groupEl, groupName, name, muscle);
          rebuildHistoryExerciseOptions();
        });
      });

      // ç·¨è¼¯ / åˆªé™¤æ•´åˆåœ¨é‰›ç­†
      document.addEventListener("click", (e) => {
        const editBtn = e.target.closest(".edit-ex-btn");
        if (editBtn) {
          const row = editBtn.closest(".sub-row");
          const titleEl = row.querySelector(".sub-title");
          const muscleEl = row.querySelector(".sub-muscle");
          const oldName = titleEl.textContent.trim();
          const oldMuscle = muscleEl.textContent.trim();

          const choice = prompt(
            `å‹•ä½œï¼šã€Œ${oldName}ã€\n` +
            `è¼¸å…¥ 1ï¼šç·¨è¼¯åç¨±èˆ‡è‚Œç¾¤\n` +
            `è¼¸å…¥ 2ï¼šåˆªé™¤æ­¤å‹•ä½œ`,
            "1"
          );
          if (!choice) return;
          if (choice === "2") {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${oldName}ã€å—ï¼Ÿ`)) {
              row.remove();
              rebuildHistoryExerciseOptions();
            }
            return;
          }
          if (choice === "1") {
            const newName = prompt("ç·¨è¼¯å‹•ä½œåç¨±ï¼š", oldName);
            if (!newName) return;
            const newMuscle = prompt("ç·¨è¼¯ä¸»è¦è‚Œç¾¤ï¼ˆå¯ç•™ç™½ï¼‰ï¼š", oldMuscle) || "";
            titleEl.textContent = newName;
            muscleEl.textContent = newMuscle;
            row.setAttribute("data-name", newName);
            rebuildHistoryExerciseOptions();
          }
        }
      });

      // å„²å­˜ï¼ˆè¨˜ç‚ºä»Šå¤©ï¼‰
      document.getElementById("saveBtn").addEventListener("click", () => {
        const dateStr = formatDate(new Date());
        const records = collectRecordsFromUI();
        const all = loadAll();
        const idx = all.findIndex((d) => d.date === dateStr);

        if (records.length === 0) {
          if (idx >= 0) {
            all.splice(idx, 1);
            saveAll(all);
            setStatus("å·²åˆªé™¤æ­¤æ—¥æœŸçš„ç´€éŒ„ã€‚", "warn");
          } else {
            setStatus("æ²’æœ‰å¯å„²å­˜çš„å…§å®¹ã€‚", "warn");
          }
        } else {
          const newObj = { date: dateStr, records };
          if (idx >= 0) all[idx] = newObj;
          else all.push(newObj);
          saveAll(all);
          setStatus("å·²å„²å­˜ " + dateStr + " çš„è¨“ç·´ç´€éŒ„ã€‚", "ok");
        }

        document.getElementById("currentDateLabel").textContent =
          "ç›®å‰é¡¯ç¤ºï¼š" + dateStr + "ï¼ˆæœ€è¿‘ä¸€æ¬¡ï¼‰";
        rebuildHistoryExerciseOptions();
      });

      // æ­·å²ä¸‹æ‹‰
      document
        .getElementById("historyExerciseSelect")
        .addEventListener("change", (e) => {
          const name = e.target.value;
          if (!name) {
            document.getElementById("historyList").innerHTML =
              `<div style="color:var(--subtext);">å°šæœªé¸æ“‡å‹•ä½œæˆ–å°šç„¡ç´€éŒ„ã€‚</div>`;
            return;
          }
          showHistoryForExercise(name);
        });

      // è¼‰å…¥æœ€è¿‘ä¸€æ¬¡
      loadLatestSession();
      rebuildHistoryExerciseOptions();
    });
  </script>
</body>
</html>