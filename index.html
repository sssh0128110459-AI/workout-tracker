<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¥èº«ç´€éŒ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* =========================
       THEME VARIABLES
    ========================== */
    :root {
      --bg: #f7f4ec;
      --card: #ffffff;
      --text: #2b2b2b;
      --subtext: #5f5f5f;
      --accent: #c5a56a;
      --accent-soft: #efe3c7;
      --border: #e0dcd2;
      --input-bg: #f3eee3;
      --shadow: rgba(0, 0, 0, 0.06);
      --row-bg: rgba(0, 0, 0, 0.02);
    }

    body.dark {
      --bg: #111111;
      --card: #1f1f1f;
      --text: #f5f5f5;
      --subtext: #b3b3b3;
      --accent: #d4a15a;
      --accent-soft: #2b2216;
      --border: #3a3a3a;
      --input-bg: #161616;
      --shadow: rgba(0, 0, 0, 0.25);
      --row-bg: rgba(255, 255, 255, 0.03);
    }

    body.iceland {
      --bg: #050806;
      --card: #101a12;
      --text: #e5f3e9;
      --subtext: #9bb8a6;
      --accent: #2faa6a;
      --accent-soft: #12251a;
      --border: #35533f;
      --input-bg: #0d1510;
      --shadow: rgba(0, 0, 0, 0.35);
      --row-bg: rgba(255, 255, 255, 0.03);
    }

    /* å®®å¤å³¶è—ï¼šæ›´æœ‰è—ç¶ å­˜åœ¨æ„Ÿ + ç™½æ²™æ„Ÿ */
    body.miyako {
      --bg: #D9F7F6;
      --card: #FFFFFF;
      --text: #06323A;
      --subtext: #2B6F78;
      --accent: #00AFC0;
      --accent-soft: #BFF1F2;
      --border: #93DDE3;
      --input-bg: #EEFEFF;
      --shadow: rgba(0, 175, 192, 0.22);
      --row-bg: rgba(0, 175, 192, 0.07);
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      transition: background 0.2s ease, color 0.2s ease;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    }

    /* å®®å¤å³¶èƒŒæ™¯å…‰æšˆ */
    body.miyako {
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(0,175,192,0.20), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(46,196,182,0.16), transparent 55%),
        var(--bg);
    }

    header {
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600; /* ä½ èªªå¤ªç²—ï¼šé€™è£¡å·²é™é‡ */
      letter-spacing: 0.3px;
    }

    main {
      max-width: 980px;
      margin: 0 auto;
      padding: 0 16px 24px;
    }

    .card {
      position: relative;
      background: var(--card);
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 12px 26px var(--shadow);
    }

    .card + .card { margin-top: 12px; }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .topbar-title {
      font-size: 16px;
      font-weight: 600; /* é™é‡ */
    }

    .btn-mini {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      background: var(--card);
      color: var(--text);
    }
    .btn-mini:hover { background: var(--accent-soft); }

    /* =========================
       TIMER UI
    ========================== */
    #timerCard { margin-top: 0; }

    .timer-top{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:10px;
    }

    .timer-label{
      font-size:12px;
      color:var(--subtext);
      font-weight:600;
    }

    .timer-clock{
      font-size:34px;
      font-weight:500;
      letter-spacing:1px;
      line-height:1.1;
    }

    .timer-controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }

    .timer-btn{
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--accent);
      color:#fff;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
    }
    .timer-btn:hover{ filter:brightness(1.04); }

    .timer-btn.ghost{
      background: transparent;
      color: var(--text);
      border-style: solid;
    }
    .timer-btn.ghost:hover{ background: var(--accent-soft); }

    .set-area{
      border-top:1px dashed var(--border);
      padding-top:10px;
    }

    .set-title{
      font-size:12px;
      color:var(--subtext);
      font-weight:700;
      margin-bottom:6px;
    }

    .set-list{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .set-chip{
      border:1px solid var(--border);
      background: var(--accent-soft);
      color: var(--text);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
    }

    @media (max-width:560px){
      .timer-clock{ font-size:30px; }
      .timer-btn{ padding:9px 10px; }
    }

    /* =========================
       TOOLS PANEL (â‹¯)
    ========================== */
    .tools-panel {
      position: absolute;
      top: 46px;
      right: 12px;
      width: min(340px, 86vw);
      background: var(--card);
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 14px 28px var(--shadow);
      padding: 10px 10px;
      display: none;
      z-index: 20;
    }
    .tools-panel.open { display: block; }

    .tools-section {
      padding-bottom: 10px;
      margin-bottom: 10px;
      border-bottom: 1px dashed var(--border);
    }
    .tools-section:last-child {
      padding-bottom: 0;
      margin-bottom: 0;
      border-bottom: none;
    }

    .tools-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--subtext);
      margin-bottom: 6px;
    }

    .tools-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 12px;
    }

    .btn-primary {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 800;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover { filter: brightness(1.04); }

    .history-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--subtext);
    }

    .history-list {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      background: rgba(0,0,0,0.02);
      max-height: 180px;
      overflow-y: auto;
      font-size: 12px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed var(--border);
    }
    .history-item:last-child { border-bottom: none; }
    .history-date { font-weight: 800; }
    .history-meta { color: var(--subtext); text-align: right; }

    /* =========================
       GROUPS
    ========================== */
    .group {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 10px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.02), transparent);
    }

    body.miyako .group {
      background: linear-gradient(to bottom, rgba(0,175,192,0.10), transparent);
    }

    .group-header {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      gap: 10px;
    }

    .group-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .group-name {
      font-size: 15px;
      font-weight: 650; /* é™é‡ */
      white-space: nowrap;
    }

    .group-last {
      font-size: 11px;
      color: var(--subtext);
      white-space: nowrap;
    }

    .group-toggle {
      font-size: 18px;
      opacity: 0.6;
      transition: transform 0.15s ease;
      flex-shrink: 0;
    }

    .group.open .group-toggle { transform: rotate(90deg); }

    .group-body {
      padding: 8px 12px 12px;
      border-top: 1px solid var(--border);
      display: none;
    }
    .group.open .group-body { display: block; }

    /* =========================
       GRID ALIGNMENT
    ========================== */
    .grid-header,
    .exercise-row {
      display: grid;
      grid-template-columns: 24px 1.6fr 1fr 1fr 1fr 40px;
      column-gap: 10px;
      align-items: center;
    }

    .grid-header {
      padding: 6px 6px 8px;
      font-size: 12px;
      color: var(--subtext);
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .grid-header .h {
      text-align: center;
      font-weight: 700;
    }
    .grid-header .h-name {
      text-align: left;
      padding-left: 2px;
    }

    .exercise-row {
      padding: 8px 6px;
      border-radius: 12px;
      background: var(--row-bg);
      border: 1px solid transparent;
      margin-bottom: 8px;
    }

    .handle {
      font-size: 14px;
      opacity: 0.65;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      cursor: grab;
      text-align: center;
    }

    .ex-title {
      font-size: 14px;
      font-weight: 700;
      line-height: 1.2;
    }
    .ex-muscle {
      font-size: 12px;
      color: var(--subtext);
      margin-top: 2px;
    }

    .cell input {
      width: 100%;
      padding: 8px 8px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 13px;
      text-align: center;
      outline: none;
    }

    .action {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .icon-btn {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--subtext);
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
    }
    .icon-btn:hover { background: var(--accent-soft); }

    .add-btn {
      margin-top: 6px;
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      font-weight: 800;
    }
    .add-btn:hover { background: var(--accent-soft); }

    .status {
      margin-top: 8px;
      font-size: 12px;
      color: var(--subtext);
    }
    .status.ok { color: #2fbf6b; }
    .status.warn { color: #f0a14a; }

    @media (max-width: 560px) {
      .grid-header,
      .exercise-row {
        column-gap: 8px;
        grid-template-columns: 22px 1.2fr 0.9fr 0.9fr 0.9fr 38px;
      }
      .ex-title { font-size: 13px; }
      .cell input { padding: 7px 6px; border-radius: 11px; }
      .icon-btn { width: 32px; height: 32px; border-radius: 11px; }
    }
  </style>
</head>

<body>
  <header>
    <h1>å¥èº«ç´€éŒ„</h1>
  </header>

  <main>
    <!-- Timer Card -->
    <section class="card" id="timerCard">
      <div class="timer-top">
        <div class="timer-label" id="timerMode">è¨“ç·´è¨ˆæ™‚</div>
        <div class="timer-clock" id="timerClock">00:00</div>
      </div>

      <div class="timer-controls">
        <button class="timer-btn" id="timerStartBtn">é–‹å§‹</button>
        <button class="timer-btn ghost" id="timerResetBtn">é‡ç½®</button>
        <button class="timer-btn" id="timerRestBtn">ä¼‘æ¯</button>
      </div>

      <div class="set-area">
        <div class="set-title">çµ„æ•¸</div>
        <div class="set-list" id="setList"></div>
      </div>
    </section>

    <!-- Workout Card -->
    <section class="card" id="appCard">
      <div class="topbar">
        <div class="topbar-title">è¨“ç·´é …ç›®</div>
        <button class="btn-mini" id="toolsBtn">â‹¯</button>
      </div>

      <!-- Tools Panel -->
      <div class="tools-panel" id="toolsPanel" aria-hidden="true">
        <div class="tools-section">
          <div class="tools-title">ä¸»é¡Œ</div>
          <div class="tools-row">
            <div style="font-size:12px;color:var(--subtext);">èƒŒæ™¯é¡è‰²</div>
            <select id="themeSelector">
              <option value="light">æ·ºè‰²</option>
              <option value="dark">æ·±è‰²</option>
              <option value="iceland">å†°å³¶è‹”åŸ</option>
              <option value="miyako">å®®å¤å³¶è—</option>
            </select>
          </div>
        </div>

        <div class="tools-section">
          <button class="btn-primary" id="saveBtn">ğŸ’¾ å„²å­˜ä»Šå¤©è¨“ç·´</button>
        </div>

        <div class="tools-section">
          <div class="tools-title">æ­·å²æŸ¥è©¢</div>
          <div class="history-row">
            <div>é¸æ“‡å‹•ä½œ</div>
            <select id="historyExerciseSelect">
              <option value="">è«‹é¸æ“‡</option>
            </select>
          </div>
          <div class="history-list" id="historyList">
            <div style="color:var(--subtext);">å°šæœªé¸æ“‡å‹•ä½œæˆ–å°šç„¡ç´€éŒ„ã€‚</div>
          </div>
        </div>
      </div>

      <div id="groupsContainer"></div>
      <div id="status" class="status"></div>
    </section>
  </main>

  <!-- SortableJS (æ‰‹æ©Ÿæ‹–æ›³å¿…å‚™) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <script>
    /*******************************
     * Storage Keys
     *******************************/
    const STORAGE_KEY = "fitness_workouts_v1"; // sessions
    const UI_KEY = "fitness_ui_v1";           // exercise library/order per group

    /*******************************
     * Date helpers
     *******************************/
    function todayStr() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    /*******************************
     * Storage: sessions
     *******************************/
    function loadAllSessions() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveAllSessions(arr) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    /*******************************
     * Status
     *******************************/
    function setStatus(msg, type) {
      const el = document.getElementById("status");
      el.textContent = msg || "";
      el.classList.remove("ok", "warn");
      if (type === "ok") el.classList.add("ok");
      if (type === "warn") el.classList.add("warn");
    }

    /*******************************
     * Default groups/exercises
     *******************************/
    const DEFAULT_GROUPS = [
      {
        group: "èƒ¸éƒ¨",
        exercises: [
          { name: "å¹³æ¿å•éˆ´è‡¥æ¨", muscle: "èƒ¸å¤§è‚Œ / è‚±ä¸‰é ­è‚Œ" },
          { name: "ä¸Šæ–œå•éˆ´è‡¥æ¨", muscle: "ä¸Šèƒ¸ / è‚±ä¸‰é ­è‚Œ" },
          { name: "å•éˆ´é£›é³¥", muscle: "èƒ¸å¤§è‚Œä¼¸å±•" }
        ]
      },
      {
        group: "èƒŒéƒ¨",
        exercises: [
          { name: "å¼•é«”å‘ä¸Š", muscle: "èƒŒé—Šè‚Œ / è‚±äºŒé ­è‚Œ" },
          { name: "é«˜ä½ä¸‹æ‹‰", muscle: "èƒŒé—Šè‚Œ" },
          { name: "åå§¿åˆ’èˆ¹", muscle: "è±å½¢è‚Œ / æ–œæ–¹è‚Œ / äºŒé ­" }
        ]
      },
      {
        group: "è…¿éƒ¨",
        exercises: [
          { name: "æ·±è¹²", muscle: "è‚¡å››é ­ / è‡€" },
          { name: "è…¿æ¨æ©Ÿ", muscle: "è‚¡å››é ­ / è‡€" },
          { name: "ç¾…é¦¬å°¼äºç¡¬èˆ‰", muscle: "è…¿å¾Œè‚Œ / è‡€" }
        ]
      },
      {
        group: "è‚©éƒ¨",
        exercises: [
          { name: "å•éˆ´è‚©æ¨", muscle: "ä¸‰è§’è‚Œå‰ä¸­æŸ" },
          { name: "å´å¹³èˆ‰", muscle: "ä¸‰è§’è‚Œä¸­æŸ" }
        ]
      },
      {
        group: "æœ‰æ°§",
        exercises: [
          { name: "è·‘æ­¥æ©Ÿ", muscle: "å¿ƒè‚º / ä¸‹è‚¢" },
          { name: "é£›è¼ªè»Š", muscle: "è…¿éƒ¨ / å¿ƒè‚º" },
          { name: "è·³ç¹©", muscle: "å°è…¿ / å¿ƒè‚º" }
        ]
      }
    ];

    /*******************************
     * Storage: UI (exercise list + order)
     *******************************/
    function loadUI() {
      try {
        const raw = localStorage.getItem(UI_KEY);
        if (!raw) return DEFAULT_GROUPS;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || parsed.length === 0) return DEFAULT_GROUPS;
        return parsed;
      } catch {
        return DEFAULT_GROUPS;
      }
    }

    function saveUI(ui) {
      localStorage.setItem(UI_KEY, JSON.stringify(ui));
    }

    let uiGroups = loadUI();

    /*******************************
     * Theme
     *******************************/
    function applyTheme(theme) {
      document.body.classList.remove("dark", "iceland", "miyako");
      if (theme === "dark") document.body.classList.add("dark");
      if (theme === "iceland") document.body.classList.add("iceland");
      if (theme === "miyako") document.body.classList.add("miyako");
      localStorage.setItem("workoutTheme", theme);
    }

    /*******************************
     * Timer + Set Counter
     *******************************/
    let timerMode = "workout";
    let workoutRunning = false;
    let restRunning = false;

    let workoutSeconds = 0;
    let restSecondsLeft = 90;

    let timerInterval = null;
    let setCount = 0;

    function formatClock(sec) {
      const s = Math.max(0, Math.floor(sec));
      const mm = String(Math.floor(s / 60)).padStart(2, "0");
      const ss = String(s % 60).padStart(2, "0");
      return `${mm}:${ss}`;
    }

    function renderTimer() {
      const modeEl = document.getElementById("timerMode");
      const clockEl = document.getElementById("timerClock");

      if (timerMode === "rest") {
        modeEl.textContent = "ä¼‘æ¯å€’æ•¸";
        clockEl.textContent = formatClock(restSecondsLeft);
      } else {
        modeEl.textContent = "è¨“ç·´è¨ˆæ™‚";
        clockEl.textContent = formatClock(workoutSeconds);
      }
    }

    function startIntervalsIfNeeded() {
      if (timerInterval) return;

      timerInterval = setInterval(() => {
        if (workoutRunning) workoutSeconds += 1;

        if (restRunning) {
          restSecondsLeft -= 1;
          if (restSecondsLeft <= 0) {
            restSecondsLeft = 0;
            restRunning = false;
            timerMode = "workout";
            renderTimer();
            beep();
          }
        }
        renderTimer();
      }, 1000);
    }

    function stopAllIntervals() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g);
        g.connect(ctx.destination);
        o.frequency.value = 880;
        g.gain.value = 0.05;
        o.start();
        setTimeout(() => {
          o.stop();
          ctx.close();
        }, 160);
      } catch {}
    }

    function appendSetChip(n) {
      const list = document.getElementById("setList");
      const chip = document.createElement("div");
      chip.className = "set-chip";
      chip.textContent = `ç¬¬ ${n} çµ„`;
      list.appendChild(chip);
    }

    function resetSetsAndTimer() {
      workoutRunning = false;
      restRunning = false;
      timerMode = "workout";
      stopAllIntervals();

      workoutSeconds = 0;
      restSecondsLeft = 90;

      setCount = 0;
      document.getElementById("setList").innerHTML = "";

      document.getElementById("timerStartBtn").textContent = "é–‹å§‹";
      renderTimer();
    }

    /*******************************
     * Sessions helpers
     *******************************/
    function latestSessionDate() {
      const all = loadAllSessions();
      if (!all.length) return null;
      all.sort((a, b) => (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));
      return all[all.length - 1].date;
    }

    function findSession(dateStr) {
      const all = loadAllSessions();
      return all.find(s => s.date === dateStr) || null;
    }

    function clearInputs() {
      document.querySelectorAll(".exercise-row").forEach(row => {
        row.querySelector(".in-weight").value = "";
        row.querySelector(".in-reps").value = "";
        row.querySelector(".in-sets").value = "";
      });
    }

    function loadSessionToUI(dateStr) {
      clearInputs();
      const sess = findSession(dateStr);
      if (!sess || !Array.isArray(sess.records)) return;

      sess.records.forEach(rec => {
        const selector = `.exercise-row[data-group="${cssEscape(rec.group)}"][data-name="${cssEscape(rec.name)}"]`;
        const row = document.querySelector(selector);
        if (!row) return;
        row.querySelector(".in-weight").value = rec.weight ?? "";
        row.querySelector(".in-reps").value = rec.reps ?? "";
        row.querySelector(".in-sets").value = rec.sets ?? "";
      });
    }

    function collectRecordsFromUI() {
      const records = [];
      document.querySelectorAll(".exercise-row").forEach(row => {
        const group = row.getAttribute("data-group");
        const name = row.getAttribute("data-name");
        const muscle = row.getAttribute("data-muscle") || "";

        const w = row.querySelector(".in-weight").value;
        const r = row.querySelector(".in-reps").value;
        const s = row.querySelector(".in-sets").value;

        if (w || r || s) {
          records.push({
            group, name, muscle,
            weight: w ? Number(w) : null,
            reps: r ? Number(r) : null,
            sets: s ? Number(s) : null
          });
        }
      });
      return records;
    }

    function groupLastDate(groupName) {
      const all = loadAllSessions();
      if (!all.length) return null;

      let best = null;
      all.forEach(sess => {
        const has = sess.records?.some(r => r.group === groupName);
        if (has) {
          if (!best || sess.date > best) best = sess.date;
        }
      });
      return best;
    }

    /*******************************
     * History panel
     *******************************/
    function rebuildHistoryExerciseOptions() {
      const select = document.getElementById("historyExerciseSelect");
      const current = select.value;

      const set = new Set();
      uiGroups.forEach(g => g.exercises.forEach(ex => set.add(ex.name)));
      loadAllSessions().forEach(sess => sess.records?.forEach(r => set.add(r.name)));

      const names = Array.from(set).sort((a, b) => a.localeCompare(b, "zh-Hant"));
      select.innerHTML = `<option value="">è«‹é¸æ“‡</option>`;
      names.forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        select.appendChild(opt);
      });

      if (current && set.has(current)) {
        select.value = current;
        showHistoryForExercise(current);
      } else {
        document.getElementById("historyList").innerHTML =
          `<div style="color:var(--subtext);">å°šæœªé¸æ“‡å‹•ä½œæˆ–å°šç„¡ç´€éŒ„ã€‚</div>`;
      }
    }

    function showHistoryForExercise(name) {
      const container = document.getElementById("historyList");
      const all = loadAllSessions().slice().sort((a, b) => (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));

      const rows = [];
      all.forEach(sess => {
        const match = sess.records?.find(r => r.name === name);
        if (match) rows.push({ date: sess.date, ...match });
      });

      if (rows.length === 0) {
        container.innerHTML = `<div style="color:var(--subtext);">é€™å€‹å‹•ä½œç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</div>`;
        return;
      }

      container.innerHTML = "";
      rows.forEach(item => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `
          <div class="history-date">${item.date}</div>
          <div class="history-meta">
            <div>${item.weight ?? "-"} kg Ã— ${item.reps ?? "-"} æ¬¡</div>
            <div>${item.sets ?? "-"} çµ„</div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    /*******************************
     * Drag & Drop (SortableJS)
     *******************************/
    function enableDragWithinGroup(groupBodyEl, groupName) {
      new Sortable(groupBodyEl, {
        animation: 150,
        handle: ".handle",
        draggable: ".exercise-row",
        filter: ".add-btn, input, button, select",
        preventOnFilter: true,
        onEnd: () => {
          persistGroupOrderFromDOM(groupName, groupBodyEl);
        }
      });
    }

    function persistGroupOrderFromDOM(groupName, groupBodyEl) {
      const group = uiGroups.find(g => g.group === groupName);
      if (!group) return;

      const orderedNames = [...groupBodyEl.querySelectorAll(".exercise-row")]
        .map(r => r.getAttribute("data-name"));

      const map = new Map(group.exercises.map(ex => [ex.name, ex]));
      const newArr = [];
      orderedNames.forEach(n => { if (map.has(n)) newArr.push(map.get(n)); });
      group.exercises.forEach(ex => { if (!orderedNames.includes(ex.name)) newArr.push(ex); });

      group.exercises = newArr;
      saveUI(uiGroups);
    }

    /*******************************
     * Render
     *******************************/
    function exerciseRowHTML(groupName, ex) {
      return `
        <div class="exercise-row"
             data-group="${escapeAttr(groupName)}"
             data-name="${escapeAttr(ex.name)}"
             data-muscle="${escapeAttr(ex.muscle || "")}">
          <div class="handle">â˜°</div>

          <div>
            <div class="ex-title">${escapeHTML(ex.name)}</div>
            <div class="ex-muscle">${escapeHTML(ex.muscle || "")}</div>
          </div>

          <div class="cell"><input class="in-weight" type="number" inputmode="decimal" placeholder="kg"></div>
          <div class="cell"><input class="in-reps" type="number" inputmode="numeric" placeholder="æ¬¡"></div>
          <div class="cell"><input class="in-sets" type="number" inputmode="numeric" placeholder="çµ„"></div>

          <div class="action">
            <button type="button" class="icon-btn ex-edit-btn" title="ç·¨è¼¯ / åˆªé™¤">âœ</button>
          </div>
        </div>
      `;
    }

    function renderApp() {
      const container = document.getElementById("groupsContainer");
      container.innerHTML = "";

      uiGroups.forEach(g => {
        const last = groupLastDate(g.group);
        const groupEl = document.createElement("div");
        groupEl.className = "group";
        groupEl.setAttribute("data-group", g.group);

        groupEl.innerHTML = `
          <div class="group-header">
            <div class="group-header-left">
              <div class="group-name">${escapeHTML(g.group)}</div>
              <div class="group-last">${last ? escapeHTML(last) : "å°šç„¡ç´€éŒ„"}</div>
            </div>
            <div class="group-toggle">â–¶</div>
          </div>

          <div class="group-body">
            <div class="grid-header">
              <div></div>
              <div class="h h-name">å‹•ä½œ</div>
              <div class="h">é‡é‡ kg</div>
              <div class="h">æ¬¡æ•¸</div>
              <div class="h">çµ„æ•¸</div>
              <div></div>
            </div>

            <div class="rows-wrap">
              ${g.exercises.map(ex => exerciseRowHTML(g.group, ex)).join("")}
            </div>

            <button class="add-btn" data-group="${escapeAttr(g.group)}">ï¼‹ æ–°å¢å‹•ä½œ</button>
          </div>
        `;

        container.appendChild(groupEl);

        const header = groupEl.querySelector(".group-header");
        header.addEventListener("click", () => groupEl.classList.toggle("open"));

        const bodyEl = groupEl.querySelector(".group-body");
        enableDragWithinGroup(bodyEl, g.group);
      });

      const lastDate = latestSessionDate();
      if (lastDate) {
        loadSessionToUI(lastDate);
        setStatus("å·²è¼‰å…¥æœ€è¿‘ä¸€æ¬¡è¨“ç·´ç´€éŒ„ï¼š" + lastDate, "ok");
      } else {
        setStatus("å°šæœªæœ‰è¨“ç·´ç´€éŒ„ï¼šå¡«å¯«å¾ŒæŒ‰å³ä¸Šè§’ â‹¯ â†’ å„²å­˜ã€‚", "warn");
      }

      rebuildHistoryExerciseOptions();
    }

    /*******************************
     * Add / Edit / Delete
     *******************************/
    function addExercise(groupName) {
      const name = prompt(`æ–°å¢ã€Œ${groupName}ã€å‹•ä½œåç¨±ï¼š`);
      if (!name) return;

      const muscle = prompt("ä¸»è¦è¨“ç·´è‚Œç¾¤ï¼ˆå¯ç•™ç™½ï¼‰ï¼š") || "";

      const group = uiGroups.find(g => g.group === groupName);
      if (!group) return;

      if (group.exercises.some(ex => ex.name === name)) {
        alert("æ­¤è‚Œç¾¤å·²å­˜åœ¨åŒåå‹•ä½œã€‚");
        return;
      }

      group.exercises.push({ name, muscle });
      saveUI(uiGroups);
      renderApp();
    }

    function editOrDeleteExercise(groupName, exName) {
      const group = uiGroups.find(g => g.group === groupName);
      if (!group) return;

      const ex = group.exercises.find(x => x.name === exName);
      if (!ex) return;

      const choice = prompt(
        `å‹•ä½œï¼šã€Œ${exName}ã€\nè¼¸å…¥ 1ï¼šç·¨è¼¯\nè¼¸å…¥ 2ï¼šåˆªé™¤`,
        "1"
      );
      if (!choice) return;

      if (choice === "2") {
        if (!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${exName}ã€ï¼Ÿ`)) return;
        group.exercises = group.exercises.filter(x => x.name !== exName);
        saveUI(uiGroups);
        renderApp();
        return;
      }

      if (choice === "1") {
        const newName = prompt("å‹•ä½œåç¨±ï¼š", ex.name);
        if (!newName) return;
        const newMuscle = prompt("ä¸»è¦è‚Œç¾¤ï¼ˆå¯ç•™ç™½ï¼‰ï¼š", ex.muscle || "") || "";

        if (newName !== ex.name && group.exercises.some(x => x.name === newName)) {
          alert("æ­¤è‚Œç¾¤å·²å­˜åœ¨åŒåå‹•ä½œã€‚");
          return;
        }

        ex.name = newName;
        ex.muscle = newMuscle;

        // rename history records to keep linkage
        const sessions = loadAllSessions();
        sessions.forEach(sess => {
          sess.records?.forEach(r => {
            if (r.group === groupName && r.name === exName) {
              r.name = newName;
              r.muscle = newMuscle;
            }
          });
        });
        saveAllSessions(sessions);

        saveUI(uiGroups);
        renderApp();
      }
    }

    /*******************************
     * Save today
     *******************************/
    function saveToday() {
      const dateStr = todayStr();
      const records = collectRecordsFromUI();
      const all = loadAllSessions();
      const idx = all.findIndex(s => s.date === dateStr);

      if (records.length === 0) {
        if (idx >= 0) {
          all.splice(idx, 1);
          saveAllSessions(all);
          setStatus("å·²åˆªé™¤ä»Šå¤©ç©ºç™½ç´€éŒ„ã€‚", "warn");
        } else {
          setStatus("æ²’æœ‰å¯å„²å­˜çš„å…§å®¹ã€‚", "warn");
        }
        renderApp();
        return;
      }

      const newSession = { date: dateStr, records };
      if (idx >= 0) all[idx] = newSession;
      else all.push(newSession);

      saveAllSessions(all);
      setStatus("å·²å„²å­˜ä»Šå¤©è¨“ç·´ï¼š" + dateStr, "ok");
      renderApp();
    }

    /*******************************
     * Utilities
     *******************************/
    function escapeHTML(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }
    function escapeAttr(str) {
      return escapeHTML(str).replace(/"/g, "&quot;");
    }
    function cssEscape(str) {
      return String(str).replace(/\\/g, "\\\\").replace(/"/g, '\\"');
    }

    /*******************************
     * Init & Events
     *******************************/
    document.addEventListener("DOMContentLoaded", () => {
      // Theme init (é è¨­ miyako)
      const themeSelector = document.getElementById("themeSelector");
      const savedTheme = localStorage.getItem("workoutTheme") || "miyako";
      themeSelector.value = savedTheme;
      applyTheme(savedTheme);
      themeSelector.addEventListener("change", () => applyTheme(themeSelector.value));

      // Tools panel
      const toolsBtn = document.getElementById("toolsBtn");
      const toolsPanel = document.getElementById("toolsPanel");

      toolsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        toolsPanel.classList.toggle("open");
        toolsPanel.setAttribute("aria-hidden", toolsPanel.classList.contains("open") ? "false" : "true");
        if (toolsPanel.classList.contains("open")) rebuildHistoryExerciseOptions();
      });

      document.addEventListener("click", (e) => {
        if (!e.target.closest("#toolsPanel") && !e.target.closest("#toolsBtn")) {
          toolsPanel.classList.remove("open");
          toolsPanel.setAttribute("aria-hidden", "true");
        }
      });

      // Save
      document.getElementById("saveBtn").addEventListener("click", () => saveToday());

      // History select
      document.getElementById("historyExerciseSelect").addEventListener("change", (e) => {
        const name = e.target.value;
        if (!name) {
          document.getElementById("historyList").innerHTML =
            `<div style="color:var(--subtext);">å°šæœªé¸æ“‡å‹•ä½œæˆ–å°šç„¡ç´€éŒ„ã€‚</div>`;
          return;
        }
        showHistoryForExercise(name);
      });

      // Delegate: add / edit
      document.addEventListener("click", (e) => {
        const addBtn = e.target.closest(".add-btn");
        if (addBtn) {
          const groupName = addBtn.getAttribute("data-group");
          addExercise(groupName);
          return;
        }

        const editBtn = e.target.closest(".ex-edit-btn");
        if (editBtn) {
          const row = editBtn.closest(".exercise-row");
          const groupName = row.getAttribute("data-group");
          const exName = row.getAttribute("data-name");
          editOrDeleteExercise(groupName, exName);
          return;
        }
      });

      // Timer bindings
      const startBtn = document.getElementById("timerStartBtn");
      const restBtn = document.getElementById("timerRestBtn");
      const resetBtn = document.getElementById("timerResetBtn");

      renderTimer();

      startBtn.addEventListener("click", () => {
        setCount += 1;
        appendSetChip(setCount);

        timerMode = "workout";
        restRunning = false;
        workoutRunning = true;

        startIntervalsIfNeeded();
        renderTimer();
      });

      restBtn.addEventListener("click", () => {
        workoutRunning = false;

        restSecondsLeft = 90; // ä¼‘æ¯ç§’æ•¸å¯æ”¹
        restRunning = true;
        timerMode = "rest";

        startIntervalsIfNeeded();
        renderTimer();
      });

      resetBtn.addEventListener("click", () => {
        resetSetsAndTimer();
      });

      renderApp();
    });
  </script>
</body>
</html>
