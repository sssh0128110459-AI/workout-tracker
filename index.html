<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¥èº«ç´€éŒ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* =========================
       THEME VARIABLES
    ========================== */
    :root {
      --bg: #f7f4ec;
      --card: #ffffff;
      --text: #2b2b2b;
      --subtext: #5f5f5f;
      --accent: #c5a56a;
      --accent-soft: #efe3c7;
      --border: #e0dcd2;
      --input-bg: #f3eee3;
      --shadow: rgba(0, 0, 0, 0.06);
    }

    body.dark {
      --bg: #111111;
      --card: #1f1f1f;
      --text: #f5f5f5;
      --subtext: #b3b3b3;
      --accent: #d4a15a;
      --accent-soft: #2b2216;
      --border: #3a3a3a;
      --input-bg: #161616;
      --shadow: rgba(0, 0, 0, 0.25);
    }

    body.iceland {
      --bg: #050806;
      --card: #101a12;
      --text: #e5f3e9;
      --subtext: #9bb8a6;
      --accent: #2faa6a;
      --accent-soft: #12251a;
      --border: #35533f;
      --input-bg: #0d1510;
      --shadow: rgba(0, 0, 0, 0.35);
    }

    /* å®®å¤å³¶è—ï¼šè— / ç¶  / ç™½ï¼Œæµ·æ°´éœ§å…‰æ„Ÿ */
    body.miyako {
      --bg: #E8F6F7;           /* ç™½æ²™ï¼‹æ·ºæµ·è— */
      --card: #FFFFFF;        /* ä¹¾æ·¨ç™½ */
      --text: #0F3A40;        /* æ·±æµ·è—ç¶  */
      --subtext: #5F8E94;     /* ç°è—ç¶  */
      --accent: #3FB6C6;      /* å®®å¤æµ·æ°´è— */
      --accent-soft: #D6F0F3; /* æ·¡æµ·æ°´è‰² */
      --border: #C3E4E8;      /* æµ·éœ§é‚Šæ¡† */
      --input-bg: #F2FBFC;    /* è–„æµ·è— */
      --shadow: rgba(63, 182, 198, 0.18);
    }

    /* =========================
       BASE
    ========================== */
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      transition: background 0.2s ease, color 0.2s ease;
    }

    header {
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    main {
      max-width: 980px;
      margin: 0 auto;
      padding: 0 16px 24px;
    }

    .card {
      position: relative;
      background: var(--card);
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 22px var(--shadow);
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .topbar-title {
      font-size: 16px;
      font-weight: 700;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-mini {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      background: var(--card);
      color: var(--text);
    }
    .btn-mini:hover { background: var(--accent-soft); }

    /* =========================
       TOOLS PANEL
    ========================== */
    .tools-panel {
      position: absolute;
      top: 46px;
      right: 12px;
      width: min(340px, 86vw);
      background: var(--card);
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 14px 28px var(--shadow);
      padding: 10px 10px;
      display: none;
      z-index: 20;
    }
    .tools-panel.open { display: block; }

    .tools-section {
      padding-bottom: 10px;
      margin-bottom: 10px;
      border-bottom: 1px dashed var(--border);
    }
    .tools-section:last-child {
      padding-bottom: 0;
      margin-bottom: 0;
      border-bottom: none;
    }

    .tools-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--subtext);
      margin-bottom: 6px;
    }

    .tools-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 12px;
    }

    .btn-primary {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover { filter: brightness(1.05); }

    .history-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--subtext);
    }

    .history-list {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      background: rgba(0,0,0,0.02);
      max-height: 170px;
      overflow-y: auto;
      font-size: 12px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed var(--border);
    }
    .history-item:last-child { border-bottom: none; }

    .history-date { font-weight: 700; }
    .history-meta { color: var(--subtext); text-align: right; }

    /* =========================
       GROUPS
    ========================== */
    .group {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 10px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.02), transparent);
    }

    .group-header {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      gap: 10px;
    }

    .group-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .group-name {
      font-size: 15px;
      font-weight: 800;
      white-space: nowrap;
    }

    /* åªç•™ï¼šæœ€è¿‘ä¸€æ¬¡æ™‚é–“ */
    .group-last {
      font-size: 11px;
      color: var(--subtext);
      white-space: nowrap;
    }

    .group-toggle {
      font-size: 18px;
      opacity: 0.6;
      transition: transform 0.15s ease;
      flex-shrink: 0;
    }

    .group.open .group-toggle { transform: rotate(90deg); }

    .group-body {
      display: none;
      padding: 8px 12px 12px;
      border-top: 1px solid var(--border);
    }
    .group.open .group-body { display: block; }

    /* =========================
       ROW GRID (Perfect alignment)
    ========================== */
    /* Grid columns:
       - handle: 24px
       - name:   1.6fr
       - w/r/s:  1fr 1fr 1fr
       - action: 40px
    */
    .grid-header,
    .exercise-row {
      display: grid;
      grid-template-columns: 24px 1.6fr 1fr 1fr 1fr 40px;
      column-gap: 10px;
      align-items: center;
    }

    .grid-header {
      padding: 6px 6px 8px;
      font-size: 12px;
      color: var(--subtext);
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .grid-header .h {
      text-align: center;
      font-weight: 700;
    }
    .grid-header .h-name {
      text-align: left;
      padding-left: 2px;
    }

    .exercise-row {
      padding: 8px 6px;
      border-radius: 10px;
      background: rgba(0,0,0,0.02);
      border: 1px solid transparent;
      margin-bottom: 8px;
    }
    .exercise-row:last-child { margin-bottom: 0; }

    .exercise-row.dragging {
      opacity: 0.6;
      border-color: var(--border);
      border-style: dashed;
    }

    .handle {
      font-size: 14px;
      opacity: 0.65;
      user-select: none;
      cursor: grab;
      text-align: center;
    }

    .ex-title {
      font-size: 14px;
      font-weight: 650;
      line-height: 1.2;
    }
    .ex-muscle {
      font-size: 12px;
      color: var(--subtext);
      margin-top: 2px;
    }

    .cell input {
      width: 100%;
      padding: 8px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 13px;
      text-align: center;
    }
    .cell input::placeholder { color: var(--subtext); }

    .action {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .icon-btn {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--subtext);
      cursor: pointer;
      font-size: 13px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .icon-btn:hover { background: var(--accent-soft); }

    .add-btn {
      margin-top: 6px;
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      font-weight: 650;
    }
    .add-btn:hover { background: var(--accent-soft); }

    .status {
      margin-top: 8px;
      font-size: 12px;
      color: var(--subtext);
    }
    .status.ok { color: #2fbf6b; }
    .status.warn { color: #f0a14a; }

    @media (max-width: 560px) {
      .grid-header,
      .exercise-row {
        column-gap: 8px;
        grid-template-columns: 24px 1.2fr 0.9fr 0.9fr 0.9fr 40px;
      }
      .ex-title { font-size: 13px; }
      .cell input { padding: 7px 6px; }
    }
  </style>
</head>

<body>
  <header>
    <h1>å¥èº«ç´€éŒ„</h1>
  </header>

  <main>
    <section class="card" id="appCard">
      <div class="topbar">
        <div class="topbar-title">è¨“ç·´é …ç›®</div>
        <div class="topbar-right">
          <button class="btn-mini" id="toolsBtn">â‹¯</button>
        </div>
      </div>

      <!-- Tools Panel -->
      <div class="tools-panel" id="toolsPanel" aria-hidden="true">
        <div class="tools-section">
          <div class="tools-title">ä¸»é¡Œ</div>
          <div class="tools-row">
            <div style="font-size:12px;color:var(--subtext);">èƒŒæ™¯é¡è‰²</div>
            <select id="themeSelector">
              <option value="light">æ·ºè‰²</option>
              <option value="dark">æ·±è‰²</option>
              <option value="iceland">å†°å³¶è‹”åŸ</option>
              <option value="miyako">å®®å¤å³¶è—</option>
            </select>
          </div>
        </div>

        <div class="tools-section">
          <button class="btn-primary" id="saveBtn">ğŸ’¾ å„²å­˜ä»Šå¤©è¨“ç·´</button>
        </div>

        <div class="tools-section">
          <div class="tools-title">æ­·å²æŸ¥è©¢</div>
          <div class="history-row">
            <div>é¸æ“‡å‹•ä½œ</div>
            <select id="historyExerciseSelect">
              <option value="">è«‹é¸æ“‡</option>
            </select>
          </div>
          <div class="history-list" id="historyList">
            <div style="color:var(--subtext);">å°šæœªé¸æ“‡å‹•ä½œæˆ–å°šç„¡ç´€éŒ„ã€‚</div>
          </div>
        </div>
      </div>

      <!-- Groups -->
      <div id="groupsContainer"></div>

      <div id="status" class="status"></div>
    </section>
  </main>

  <script>
    /*******************************
     * Storage Schema (Single Key)
     *******************************/
    const STORAGE_KEY = "fitness_workouts_v1";

    function todayStr() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function loadAllSessions() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveAllSessions(arr) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function setStatus(msg, type) {
      const el = document.getElementById("status");
      el.textContent = msg || "";
      el.classList.remove("ok", "warn");
      if (type === "ok") el.classList.add("ok");
      if (type === "warn") el.classList.add("warn");
    }

    /*******************************
     * Default exercise library
     *******************************/
    const DEFAULT_GROUPS = [
      {
        group: "èƒ¸éƒ¨",
        exercises: [
          { name: "å¹³æ¿å•éˆ´è‡¥æ¨", muscle: "èƒ¸å¤§è‚Œ / è‚±ä¸‰é ­è‚Œ" },
          { name: "ä¸Šæ–œå•éˆ´è‡¥æ¨", muscle: "ä¸Šèƒ¸ / è‚±ä¸‰é ­è‚Œ" },
          { name: "å•éˆ´é£›é³¥", muscle: "èƒ¸å¤§è‚Œä¼¸å±•" }
        ]
      },
      {
        group: "èƒŒéƒ¨",
        exercises: [
          { name: "å¼•é«”å‘ä¸Š", muscle: "èƒŒé—Šè‚Œ / è‚±äºŒé ­è‚Œ" },
          { name: "é«˜ä½ä¸‹æ‹‰", muscle: "èƒŒé—Šè‚Œ" },
          { name: "åå§¿åˆ’èˆ¹", muscle: "è±å½¢è‚Œ / æ–œæ–¹è‚Œ / äºŒé ­" }
        ]
      },
      {
        group: "è…¿éƒ¨",
        exercises: [
          { name: "æ·±è¹²", muscle: "è‚¡å››é ­ / è‡€" },
          { name: "è…¿æ¨æ©Ÿ", muscle: "è‚¡å››é ­ / è‡€" },
          { name: "ç¾…é¦¬å°¼äºç¡¬èˆ‰", muscle: "è…¿å¾Œè‚Œ / è‡€" }
        ]
      },
      {
        group: "è‚©éƒ¨",
        exercises: [
          { name: "å•éˆ´è‚©æ¨", muscle: "ä¸‰è§’è‚Œå‰ä¸­æŸ" },
          { name: "å´å¹³èˆ‰", muscle: "ä¸‰è§’è‚Œä¸­æŸ" }
        ]
      },
      {
        group: "æœ‰æ°§",
        exercises: [
          { name: "è·‘æ­¥æ©Ÿ", muscle: "å¿ƒè‚º / ä¸‹è‚¢" },
          { name: "é£›è¼ªè»Š", muscle: "è…¿éƒ¨ / å¿ƒè‚º" },
          { name: "è·³ç¹©", muscle: "å°è…¿ / å¿ƒè‚º" }
        ],
        cardioMode: true
      }
    ];

    /*******************************
     * UI State: exercise definitions (order + custom)
     *******************************/
    const UI_KEY = "fitness_ui_v1";

    function loadUI() {
      try {
        const raw = localStorage.getItem(UI_KEY);
        if (!raw) return DEFAULT_GROUPS;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || parsed.length === 0) return DEFAULT_GROUPS;
        return parsed;
      } catch {
        return DEFAULT_GROUPS;
      }
    }

    function saveUI(ui) {
      localStorage.setItem(UI_KEY, JSON.stringify(ui));
    }

    let uiGroups = loadUI();

    /*******************************
     * Theme
     *******************************/
    function applyTheme(theme) {
      document.body.classList.remove("dark", "iceland", "miyako");
      if (theme === "dark") document.body.classList.add("dark");
      if (theme === "iceland") document.body.classList.add("iceland");
      if (theme === "miyako") document.body.classList.add("miyako");
      localStorage.setItem("workoutTheme", theme);
    }

    /*******************************
     * Sessions helpers
     *******************************/
    function latestSessionDate() {
      const all = loadAllSessions();
      if (!all.length) return null;
      all.sort((a,b) => (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));
      return all[all.length - 1].date;
    }

    function findSession(dateStr) {
      const all = loadAllSessions();
      return all.find(s => s.date === dateStr) || null;
    }

    function collectRecordsFromUI() {
      const records = [];
      document.querySelectorAll(".exercise-row").forEach(row => {
        const group = row.getAttribute("data-group");
        const name = row.getAttribute("data-name");
        const muscle = row.getAttribute("data-muscle") || "";

        const w = row.querySelector(".in-weight").value;
        const r = row.querySelector(".in-reps").value;
        const s = row.querySelector(".in-sets").value;

        if (w || r || s) {
          records.push({
            group, name, muscle,
            weight: w ? Number(w) : null,
            reps: r ? Number(r) : null,
            sets: s ? Number(s) : null
          });
        }
      });
      return records;
    }

    function clearInputs() {
      document.querySelectorAll(".exercise-row").forEach(row => {
        row.querySelector(".in-weight").value = "";
        row.querySelector(".in-reps").value = "";
        row.querySelector(".in-sets").value = "";
      });
    }

    function loadSessionToUI(dateStr) {
      clearInputs();
      const sess = findSession(dateStr);
      if (!sess || !Array.isArray(sess.records)) return;

      sess.records.forEach(rec => {
        const selector = `.exercise-row[data-group="${cssEscape(rec.group)}"][data-name="${cssEscape(rec.name)}"]`;
        const row = document.querySelector(selector);
        if (!row) return;
        row.querySelector(".in-weight").value = rec.weight ?? "";
        row.querySelector(".in-reps").value = rec.reps ?? "";
        row.querySelector(".in-sets").value = rec.sets ?? "";
      });
    }

    function groupLastDate(groupName) {
      const all = loadAllSessions();
      if (!all.length) return null;

      let best = null;
      all.forEach(sess => {
        const has = sess.records?.some(r => r.group === groupName);
        if (has) {
          if (!best || sess.date > best) best = sess.date;
        }
      });
      return best;
    }

    /*******************************
     * History panel
     *******************************/
    function rebuildHistoryExerciseOptions() {
      const select = document.getElementById("historyExerciseSelect");
      const current = select.value;

      const set = new Set();
      // UI exercises
      uiGroups.forEach(g => g.exercises.forEach(ex => set.add(ex.name)));
      // saved exercises
      loadAllSessions().forEach(sess => sess.records?.forEach(r => set.add(r.name)));

      const names = Array.from(set).sort((a,b) => a.localeCompare(b, "zh-Hant"));
      select.innerHTML = `<option value="">è«‹é¸æ“‡</option>`;
      names.forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        select.appendChild(opt);
      });

      if (current && set.has(current)) {
        select.value = current;
        showHistoryForExercise(current);
      } else {
        document.getElementById("historyList").innerHTML =
          `<div style="color:var(--subtext);">å°šæœªé¸æ“‡å‹•ä½œæˆ–å°šç„¡ç´€éŒ„ã€‚</div>`;
      }
    }

    function showHistoryForExercise(name) {
      const container = document.getElementById("historyList");
      const all = loadAllSessions().slice().sort((a,b) => (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));

      const rows = [];
      all.forEach(sess => {
        const match = sess.records?.find(r => r.name === name);
        if (match) rows.push({ date: sess.date, ...match });
      });

      if (rows.length === 0) {
        container.innerHTML = `<div style="color:var(--subtext);">é€™å€‹å‹•ä½œç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</div>`;
        return;
      }

      container.innerHTML = "";
      rows.forEach(item => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `
          <div class="history-date">${item.date}</div>
          <div class="history-meta">
            <div>${item.weight ?? "-"} kg Ã— ${item.reps ?? "-"} æ¬¡</div>
            <div>${item.sets ?? "-"} çµ„</div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    /*******************************
     * Drag and drop per group
     *******************************/
    function enableDragWithinGroup(groupBodyEl, groupName) {
      let draggingEl = null;

      groupBodyEl.addEventListener("dragstart", (e) => {
        const handle = e.target.closest(".handle");
        if (!handle) {
          e.preventDefault();
          return;
        }
        const row = handle.closest(".exercise-row");
        draggingEl = row;
        row.classList.add("dragging");
      });

      groupBodyEl.addEventListener("dragend", (e) => {
        const row = e.target.closest(".exercise-row");
        if (row) row.classList.remove("dragging");
        draggingEl = null;

        // persist order back to uiGroups
        persistGroupOrderFromDOM(groupName, groupBodyEl);
      });

      groupBodyEl.addEventListener("dragover", (e) => {
        e.preventDefault();
        if (!draggingEl) return;

        const after = getDragAfterElement(groupBodyEl, e.clientY);
        const addBtn = groupBodyEl.querySelector(".add-btn");

        if (!after) {
          groupBodyEl.insertBefore(draggingEl, addBtn);
        } else {
          groupBodyEl.insertBefore(draggingEl, after);
        }
      });
    }

    function getDragAfterElement(container, y) {
      const candidates = [...container.querySelectorAll(".exercise-row:not(.dragging)")];
      let closest = { offset: Number.NEGATIVE_INFINITY, element: null };

      candidates.forEach(child => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          closest = { offset, element: child };
        }
      });

      return closest.element;
    }

    function persistGroupOrderFromDOM(groupName, groupBodyEl) {
      const group = uiGroups.find(g => g.group === groupName);
      if (!group) return;

      const orderedNames = [...groupBodyEl.querySelectorAll(".exercise-row")]
        .map(r => r.getAttribute("data-name"));

      const map = new Map(group.exercises.map(ex => [ex.name, ex]));
      const newArr = [];
      orderedNames.forEach(n => {
        if (map.has(n)) newArr.push(map.get(n));
      });

      // include any missing (safety)
      group.exercises.forEach(ex => {
        if (!orderedNames.includes(ex.name)) newArr.push(ex);
      });

      group.exercises = newArr;
      saveUI(uiGroups);
    }

    /*******************************
     * Build UI
     *******************************/
    function renderApp() {
      const container = document.getElementById("groupsContainer");
      container.innerHTML = "";

      uiGroups.forEach(g => {
        const last = groupLastDate(g.group);
        const groupEl = document.createElement("div");
        groupEl.className = "group";
        groupEl.setAttribute("data-group", g.group);

        groupEl.innerHTML = `
          <div class="group-header">
            <div class="group-header-left">
              <div class="group-name">${g.group}</div>
              <div class="group-last">${last ? last : "å°šç„¡ç´€éŒ„"}</div>
            </div>
            <div class="group-toggle">â–¶</div>
          </div>

          <div class="group-body">
            <div class="grid-header">
              <div></div>
              <div class="h h-name">å‹•ä½œ</div>
              <div class="h">é‡é‡ kg</div>
              <div class="h">æ¬¡æ•¸</div>
              <div class="h">çµ„æ•¸</div>
              <div></div>
            </div>

            ${g.exercises.map(ex => exerciseRowHTML(g.group, ex)).join("")}

            <button class="add-btn" data-group="${g.group}">ï¼‹ æ–°å¢å‹•ä½œ</button>
          </div>
        `;

        container.appendChild(groupEl);

        // toggle
        const header = groupEl.querySelector(".group-header");
        header.addEventListener("click", () => {
          groupEl.classList.toggle("open");
        });

        // drag enabled within group body
        enableDragWithinGroup(groupEl.querySelector(".group-body"), g.group);
      });

      // load latest session into UI
      const lastDate = latestSessionDate();
      if (lastDate) {
        loadSessionToUI(lastDate);
        setStatus("å·²è¼‰å…¥æœ€è¿‘ä¸€æ¬¡è¨“ç·´ç´€éŒ„ï¼š" + lastDate, "ok");
      } else {
        setStatus("å°šæœªæœ‰è¨“ç·´ç´€éŒ„ï¼Œå¡«å¯«å¾ŒæŒ‰å³ä¸Šè§’ â‹¯ â†’ å„²å­˜ã€‚", "warn");
      }

      rebuildHistoryExerciseOptions();
    }

    function exerciseRowHTML(groupName, ex) {
      return `
        <div class="exercise-row" draggable="true"
             data-group="${escapeAttr(groupName)}"
             data-name="${escapeAttr(ex.name)}"
             data-muscle="${escapeAttr(ex.muscle || "")}">
          <div class="handle">â˜°</div>

          <div>
            <div class="ex-title">${escapeHTML(ex.name)}</div>
            <div class="ex-muscle">${escapeHTML(ex.muscle || "")}</div>
          </div>

          <div class="cell"><input class="in-weight" type="number" inputmode="decimal" placeholder="kg"></div>
          <div class="cell"><input class="in-reps" type="number" inputmode="numeric" placeholder="æ¬¡"></div>
          <div class="cell"><input class="in-sets" type="number" inputmode="numeric" placeholder="çµ„"></div>

          <div class="action">
            <button type="button" class="icon-btn ex-edit-btn" title="ç·¨è¼¯ / åˆªé™¤">âœ</button>
          </div>
        </div>
      `;
    }

    /*******************************
     * Actions (Add / Edit / Delete)
     *******************************/
    function addExercise(groupName) {
      const name = prompt(`æ–°å¢ã€Œ${groupName}ã€å‹•ä½œåç¨±ï¼š`);
      if (!name) return;

      const muscle = prompt("ä¸»è¦è¨“ç·´è‚Œç¾¤ï¼ˆå¯ç•™ç™½ï¼‰ï¼š") || "";

      const group = uiGroups.find(g => g.group === groupName);
      if (!group) return;

      // prevent duplicate names within same group
      const exists = group.exercises.some(ex => ex.name === name);
      if (exists) {
        alert("æ­¤è‚Œç¾¤å·²å­˜åœ¨åŒåå‹•ä½œã€‚");
        return;
      }

      group.exercises.push({ name, muscle });
      saveUI(uiGroups);
      renderApp();
    }

    function editOrDeleteExercise(groupName, exName) {
      const group = uiGroups.find(g => g.group === groupName);
      if (!group) return;

      const ex = group.exercises.find(x => x.name === exName);
      if (!ex) return;

      const choice = prompt(
        `å‹•ä½œï¼šã€Œ${exName}ã€\nè¼¸å…¥ 1ï¼šç·¨è¼¯\nè¼¸å…¥ 2ï¼šåˆªé™¤`,
        "1"
      );
      if (!choice) return;

      if (choice === "2") {
        if (!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${exName}ã€ï¼Ÿ`)) return;
        group.exercises = group.exercises.filter(x => x.name !== exName);
        saveUI(uiGroups);
        renderApp();
        return;
      }

      if (choice === "1") {
        const newName = prompt("å‹•ä½œåç¨±ï¼š", ex.name);
        if (!newName) return;
        const newMuscle = prompt("ä¸»è¦è‚Œç¾¤ï¼ˆå¯ç•™ç™½ï¼‰ï¼š", ex.muscle || "") || "";

        // handle rename duplicates
        if (newName !== ex.name && group.exercises.some(x => x.name === newName)) {
          alert("æ­¤è‚Œç¾¤å·²å­˜åœ¨åŒåå‹•ä½œã€‚");
          return;
        }

        // update UI exercise definition
        ex.name = newName;
        ex.muscle = newMuscle;

        // also update historical records names (optional but practical)
        // to keep history connected after rename
        const sessions = loadAllSessions();
        sessions.forEach(sess => {
          sess.records?.forEach(r => {
            if (r.group === groupName && r.name === exName) {
              r.name = newName;
              r.muscle = newMuscle;
            }
          });
        });
        saveAllSessions(sessions);

        saveUI(uiGroups);
        renderApp();
      }
    }

    /*******************************
     * Save today
     *******************************/
    function saveToday() {
      const dateStr = todayStr();
      const records = collectRecordsFromUI();
      const all = loadAllSessions();
      const idx = all.findIndex(s => s.date === dateStr);

      if (records.length === 0) {
        if (idx >= 0) {
          all.splice(idx, 1);
          saveAllSessions(all);
          setStatus("å·²åˆªé™¤ä»Šå¤©ç©ºç™½ç´€éŒ„ã€‚", "warn");
        } else {
          setStatus("æ²’æœ‰å¯å„²å­˜çš„å…§å®¹ã€‚", "warn");
        }
        renderApp();
        return;
      }

      const newSession = { date: dateStr, records };
      if (idx >= 0) all[idx] = newSession;
      else all.push(newSession);

      saveAllSessions(all);
      setStatus("å·²å„²å­˜ä»Šå¤©è¨“ç·´ï¼š" + dateStr, "ok");
      renderApp();
    }

    /*******************************
     * Utilities
     *******************************/
    function escapeHTML(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }

    function escapeAttr(str) {
      return escapeHTML(str).replace(/"/g, "&quot;");
    }

    // for querySelector attribute exact match: escape special chars
    function cssEscape(str) {
      // minimal escape for quotes/backslashes; enough for typical names
      return String(str).replace(/\\/g, "\\\\").replace(/"/g, '\\"');
    }

    /*******************************
     * Events
     *******************************/
    document.addEventListener("DOMContentLoaded", () => {
      // Theme init
      const themeSelector = document.getElementById("themeSelector");
      const savedTheme = localStorage.getItem("workoutTheme") || "miyako";
      themeSelector.value = savedTheme;
      applyTheme(savedTheme);
      themeSelector.addEventListener("change", () => applyTheme(themeSelector.value));

      // Tools panel open/close
      const toolsBtn = document.getElementById("toolsBtn");
      const toolsPanel = document.getElementById("toolsPanel");

      toolsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        toolsPanel.classList.toggle("open");
        toolsPanel.setAttribute("aria-hidden", toolsPanel.classList.contains("open") ? "false" : "true");
        if (toolsPanel.classList.contains("open")) rebuildHistoryExerciseOptions();
      });

      document.addEventListener("click", (e) => {
        if (!e.target.closest("#toolsPanel") && !e.target.closest("#toolsBtn")) {
          toolsPanel.classList.remove("open");
          toolsPanel.setAttribute("aria-hidden", "true");
        }
      });

      // Save
      document.getElementById("saveBtn").addEventListener("click", () => saveToday());

      // History select
      document.getElementById("historyExerciseSelect").addEventListener("change", (e) => {
        const name = e.target.value;
        if (!name) {
          document.getElementById("historyList").innerHTML =
            `<div style="color:var(--subtext);">å°šæœªé¸æ“‡å‹•ä½œæˆ–å°šç„¡ç´€éŒ„ã€‚</div>`;
          return;
        }
        showHistoryForExercise(name);
      });

      // Delegate: add / edit
      document.addEventListener("click", (e) => {
        const addBtn = e.target.closest(".add-btn");
        if (addBtn) {
          const groupName = addBtn.getAttribute("data-group");
          addExercise(groupName);
          return;
        }

        const editBtn = e.target.closest(".ex-edit-btn");
        if (editBtn) {
          const row = editBtn.closest(".exercise-row");
          const groupName = row.getAttribute("data-group");
          const exName = row.getAttribute("data-name");
          editOrDeleteExercise(groupName, exName);
          return;
        }
      });

      renderApp();
    });
  </script>
</body>
</html>
